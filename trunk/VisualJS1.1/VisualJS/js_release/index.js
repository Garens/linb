Class("VisualJS","linb.Com",{Constructor:function(){var self=this,o=linb.message;arguments.callee.upper.apply(self,arguments);SPA=this;self.curProject=null;self.Message=[];linb.message=function(content){if(self.Message.length>20){self.Message.pop()}if(typeof content!="string"){content=String(content)}if(/</.test(content)){content=content.replace(/</g,"&lt; ")}self.Message.unshift({id:_.id(),caption:content});self.toolbar.updateItem("info",content.left(50));o.apply(null,arguments)}},Instance:{events:{beforeCreated:function(){linb.dom.setCover("Created",true)},onLoadBaseClass:function(com,threadid,key){linb.dom.setCover("Load Base Class: "+key,true)},onLoadResource:function(){linb.dom.setCover("Load Resource",true)},onLoadWidgets:function(com,threadid,key){linb.dom.setCover("Load widgets: "+com.KEY+key)},onReady:function(page){linb.ComFactory.setProfile(CONF.ComFactoryProfile);this.menubar.setItems([{id:"file",caption:"$VisualJS.menu.file",sub:[{id:"newproject",caption:"$VisualJS.menu.newproject",icon:"img/App.gif",iconPos:"-32px top"},{id:"openproject",caption:"$VisualJS.menu.openproject",add:"Ctrl+Alt+O",icon:"img/App.gif",iconPos:"-48px top"},{id:"closeproject",caption:"$VisualJS.menu.closeproject"},{type:"split"},{id:"saveall",caption:"$VisualJS.menu.saveall",add:"Ctrl+Alt+S",icon:"img/App.gif",iconPos:"-96px top"}]},{id:"build",caption:"$VisualJS.menu.build",sub:[{id:"debug",caption:"$VisualJS.menu.debug",icon:"img/App.gif",iconPos:"top left",add:"F9"},{id:"release",caption:"$VisualJS.menu.release",icon:"img/App.gif",iconPos:"-64px top",add:"Ctrl+F9"}]},{id:"help",caption:"$VisualJS.menu.help",sub:[{id:"forum",caption:"$VisualJS.menu.forum"},{id:"download",caption:"$VisualJS.menu.download",icon:"img/App.gif",iconPos:"-144px 0px"},{type:"split"},{id:"license",caption:"$VisualJS.menu.license",sub:[{id:"gpllicense",caption:"$VisualJS.menu.gpllicense"},{id:"clicense",caption:"$VisualJS.menu.clicense"},{id:"purchase",caption:"$VisualJS.menu.purchase"}]},{type:"split"},{id:"flash",icon:"img/App.gif",iconPos:"-128px -17px",caption:"$VisualJS.tool.flash"},{id:"demo",icon:"img/App.gif",iconPos:"-48px -64px ",caption:"$VisualJS.tool.demo"},{type:"split"},{id:"about",caption:"$VisualJS.menu.about"}]}]);this.toolbar.setItems([{id:"only",sub:[{id:"newproject",icon:"img/App.gif",iconPos:"-32px top",tips:"$VisualJS.tool.newp"},{id:"openproject",icon:"img/App.gif",iconPos:"-48px top",tips:"$VisualJS.tool.open"},{type:"split"},{id:"saveall",icon:"img/App.gif",iconPos:"-96px top",tips:"$VisualJS.tool.saveall"},{type:"split"},{id:"debug",icon:"img/App.gif",iconPos:"top left",tips:"$VisualJS.tool.debug"},{id:"release",icon:"img/App.gif",iconPos:"-64px top",tips:"$VisualJS.tool.release"},{type:"split"},{id:"download",tips:"$VisualJS.menu.download",icon:"img/App.gif",iconPos:"-144px 0px"},{id:"flash",icon:"img/App.gif",iconPos:"-128px -17px",tips:"$VisualJS.tool.flash"},{id:"demo",icon:"img/App.gif",iconPos:"-48px -64px ",tips:"$VisualJS.tool.demo"},{type:"split"},{id:"ec",icon:"img/App.gif",iconPos:"-98px -16px",tips:"$VisualJS.tool.ec"},{type:"split"},{id:"info",icon:"img/App.gif",iconPos:"-286px -64px ",caption:"$VisualJS.noMessage",tips:"$VisualJS.message"}]}])},afterShow:function(page){var key="prj",r="([&|?|#]|\\b)("+key+"=)([^&]*)([&]?)",a=location.href.match(new RegExp(r)),prj=_.isNull(a)?"":decodeURIComponent(a[3]);if(prj){prj=CONF.prjPath+prj;linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"open",hashCode:_.id(),path:prj}}),function(txt){var obj=_.unserialize(txt);if(obj&&!obj.error){page._openproject(prj,obj)}else{linb.message(txt)}})}page.proxy=new linb.UI.IFrame({height:1,left:-10000,top:-10000,src:"javascript:;"});linb(document.body).attach(page.proxy);page.$infoList=new linb.UI.List({shadow:true,resizable:true,width:400}).setCustomAppearance("ITEM","border-bottom:dashed 1px gray").create()}},base:["linb.UI"],required:["linb.UI.List","linb.UI.PopMenu","linb.UI.MenuBar","linb.UI.ToolBar","linb.UI.Layout","linb.UI.Tabs","linb.UI.TreeBar","linb.UI.Dialog","linb.UI.PanelBar","linb.UI.IFrame","linb.UI.Tips","linb.UI.Shadow","linb.UI.Resizer","linb.UI.Edge","linb.UI.Div"],background:["VisualJS.ProjectSelector","VisualJS.ProjectPro","VisualJS.PageEditor","VisualJS.ClassTool","VisualJS.ClassEditor","VisualJS.ClassStruct","VisualJS.ObjectEditor","VisualJS.Designer","VisualJS.AddFile","VisualJS.DelFile","VisualJS.About","linb.coder","linb.UI.Label","linb.UI.Button","linb.UI.CheckBox","linb.UI.Input","linb.UI.ComboInput","linb.UI.Group","linb.UI.IconList","linb.UI.RadioBox","linb.UI.Block","linb.UI.Stacks","linb.UI.ButtonViews","linb.UI.TextEditor","linb.UI.TreeGrid"],_addfile:function(id,path,name,type){var tb=this.treebarPrj,pathadd;if(type!="/"){name=name+type;pathadd=path+"/"+name}else{pathadd=path=path+"/"+name}linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"add",hashCode:_.id(),type:type=="/"?"dir":"file",path:path,filename:name}}),function(txt){var obj=_.unserialize(txt);if(obj&&obj.OK){var iconPos;if(type=="/"){iconPos="-48px top"}else{var a=name.split(".");switch(a[1].toLowerCase()){case"html":iconPos="-112px -48px";break;case"js":iconPos="-16px -48px";break;default:iconPos="-96px -48px"}}tb.insertItems([{id:pathadd,caption:name,icon:"img/App.gif",iconPos:iconPos,value:pathadd,sub:type=="/"?[]:null}],id)}else{linb.message(txt)}})},_delfile:function(id){var tb=this.treebarPrj,tab=this.tabsMain;arr=id.split(";"),a=[];arr.each(function(o,i){a[i]=o});linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"del",hashCode:_.id(),path:a}}),function(txt){var obj=_.unserialize(txt);if(obj&&obj.OK){tb.removeItems(arr);var items=tab.getItems(),b=[];items.each(function(o){if(!tb.getSubSerialIdByItemId(o.id)){b.push(o.id)}},null,true);tab.removeItems(b)}else{linb.message(txt)}})},_projecttool_onclick:function(profile,id,groupid,src){var self=this;switch(id){case"new":linb.ComFactory.getCom("addFile",null,function(){this.host=self;this.setProperties({icon:"img/App.gif",iconPos:"-0px -16px",caption:"$VisualJS.tool2.new",onOK:self._addfile,fromRegion:linb(src).getRegion(true),items:self.curPrjFiles});this.show(linb([document.body]))});break;case"delete":linb.ComFactory.getCom("delFile",null,function(){this.host=self;this.setProperties({fromRegion:linb(src).getRegion(true),icon:"img/App.gif",iconPos:"-80px -16px",caption:"$VisualJS.tool2.del",items:self.curPrjFiles,onOK:self._delfile});this.show(linb([document.body]))});break;case"refresh":linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"open",hashCode:_.id(),path:self.curProject}}),function(txt){var obj=_.unserialize(txt);if(!obj||obj.error){linb.message(txt)}else{_.tryF(self._openproject,[self.curProject,obj],self);linb.message(linb.getRes("VisualJS.tool2.refreshOK"))}});break}},_closeproject:function(callback){var self=this,dirty,tb=this.tabsMain,items=tb.getItems(),tree=this.treebarPrj;items.each(function(o){if(o._dirty){return !(dirty=true)}});var fun=function(){tb.clearItems();tree.clearItems();self.curProject=null;this.curPrjFiles=[];self.projecttool.setDisabled(true);if(typeof callback=="function"){callback()}};if(dirty){linb.UI.Dialog.confirm(linb.getRes("VisualJS.notsave"),linb.getRes("VisualJS.notsave2"),fun)}else{fun()}},_tabsmain_beforepageclose:function(profile,item,src){if(item._dirty){linb.UI.Dialog.confirm(linb.getRes("VisualJS.notsave"),linb.getRes("VisualJS.notsave2"),function(){profile.boxing().removeItems(item.id)});return false}},_tabsmain_afterpageclose:function(profile,item,src){if(item.$obj){item.$obj.destroy()}},_tabsmain_beforeValueUpdated:function(profile,ov,nv){var item=this.tabsMain.getItemByItemId(ov);if(!item){return }if(t=item.$obj){if(t.getText()===false){return false}}},_tabmain_onitemselected:function(profile,item,src){_.tryF(function(){if(item.$obj){item.$obj.activate()}})},_treebarprj_onitemselected:function(profile,item,src){if(!item.id){return }var page=this,type=item.caption.split(".")[1];if(type!="js"&&type!="html"&&type!="php"){linb.dom.submit(item.id);return }var value=item.value,arr=value.split("/"),filename=arr[arr.length-1],filetype=filename.split(".")[1],iconPos=filetype=="js"?"-16px -48px":"-128px -48px";filetype=filetype=="js"?"class":filetype;var tb=page.tabsMain,t=linb([src],false).getRegion(true),pro=tb.reBoxing().getRegion(true);if(tb.getItemByItemId(value)){tb.fireItemClickEvent(value)}else{linb.dom.fxProxy(t,pro,null,function(){var item={id:value,tips:value,caption:filename,closeBtn:true,icon:"img/App.gif",iconPos:iconPos},items=tb.getItems();tb.insertItems([item],items.length?items[items.length-1].id:null);tb.fireItemClickEvent(value);var fun=function(txt){var itemid=item.id;var callback=function(pagprofile,pro,b){tb.markDirty(pagprofile.properties.keyId,b)};item.newText=item.text=txt;if(filetype!="class"){linb.ComFactory.newCom("VisualJS.PageEditor",function(){this.host=page;this.setProperties({text:txt,checkType:filetype,keyId:itemid});this.setEvents("onValueChanged",callback);this.show(null,tb.getCurPanel());item.$obj=this})}else{linb.ComFactory.newCom("VisualJS.ClassEditor",function(){this.host=page;this.setProperties({$design:page.curProject,checkType:"js",text:txt,keyId:itemid});this.setEvents("onValueChanged",callback);this.show(null,tb.getCurPanel());item.$obj=this})}};if(filetype!="php"){linb.request(value,"",fun)}else{linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"getfile",hashCode:_.id(),path:value}}),fun)}},240,8,"inexp").start()}},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.ToolBar).host(t,"toolbar").setDockOrder("2").setItems([]).onClick("_toolbar_onclick"));f((new u.MenuBar).host(t,"menubar").setDockOrder("1").setItems([]).onMenuSelected("_menubar_onclick"));f((new u.Div).host(t,"float").afterCreated(function(pro){pro.root.onClick(function(){linb.dom.submit("http://www.linb.net")})}).setCustomAppearance({KEY:"background-image:url(img/logo.gif);position:absolute;top:0px;right:0px;width:120px;height:60px;z-index:100;cursor:pointer;"}));f((new u.Layout).host(t,"layout").setLeft(0).setTop(0).setItems([{id:"before",pos:"before",locked:false,size:150,min:50,max:300,cmd:true,hide:false},{id:"main",min:10}]).setType("horizontal"));t.layout.attach((new u.PanelBar).host(t,"panelbar2").setCaption("$VisualJS.pm.title").setIcon("img/App.gif").setIconPos("-128px -48px"),"before");t.panelbar2.attach((new u.TreeBar).host(t,"treebarPrj").setSelMode("none").setPosition("relative").setDock("none").setItems([]).setIniFold(false).setGroup(true).onItemSelected("_treebarprj_onitemselected"));t.layout.attach((new u.Tabs).host(t,"tabsMain").setLeft(0).setTop(0).setItems([]).beforeValueUpdated("_tabsmain_beforeValueUpdated").beforePageClose("_tabsmain_beforepageclose").afterPageClose("_tabsmain_afterpageclose").onItemSelected("_tabmain_onitemselected"),"main");t.layout.attach((new u.ToolBar).host(t,"projecttool").setDock("bottom").setHandler(false).setAlign("right").setDisabled(true).setItems([{id:"only",sub:[{id:"refresh",icon:"img/App.gif",iconPos:"-113px -16px",tips:"$VisualJS.tool2.refresh"},{type:"split"},{id:"new",icon:"img/App.gif",iconPos:"-0px -16px",tips:"$VisualJS.tool2.new"},{id:"delete",icon:"img/App.gif",iconPos:"-80px -16px",tips:"$VisualJS.tool2.del"}]}]).afterCreated(function(profile){profile.getSubNode("ITEMS").setStyle({borderLeftWidth:0,borderRightWidth:0,borderBottomWidth:0})}).onClick("_projecttool_onclick"),"before");return n},_toolbar_onclick:function(profile,id,groupid,src){this._menubar_onclick(this.menubar.get(0),id,null,src)},_openproject:function(pm,obj){this.curProject=pm;var tb=this.treebarPrj;obj.sort(function(x,y){return x.layer<y.layer?1:x.layer==y.layer?(x.type>y.type?1:x.type==y.type?(x.location>y.location?1:-1):-1):-1});var names=pm.split("/"),name=names[names.length-1],iconPos,hash={"*":{id:pm,caption:name,icon:"img/App.gif",iconPos:"-128px -48px",value:pm,sub:[]}},arr=[hash["*"]];obj.each(function(o){if(!o.type){iconPos="-48px top"}else{var a=o.name.split(".");switch(a[1].toLowerCase()){case"html":iconPos="-112px -48px";break;case"js":iconPos="-16px -48px";break;default:iconPos="-96px -48px"}}hash[o.id]={id:o.location,caption:o.name,icon:"img/App.gif",iconPos:iconPos,value:o.location};if(!o.type){hash[o.id].sub=[]}hash[o.pid].sub.push(hash[o.id])});tb.clearItems();tb.insertItems(arr);this.curPrjFiles=tb.getItems();this.projecttool.setDisabled(false)},_menubar_onclick:function(profile,id,item,src){var self=this;switch(id){case"newproject":var callback=function(){linb.ComFactory.getCom("prjPro",null,function(){this.host=self;this.setProperties({caption:"$VisualJS.dialog.newone",projectName:"linbApp",jsLINBPath:"",className:"App",readonly:false,icon:"img/App.gif",iconPos:"-32px top",fromRegion:linb(src).getRegion(true),onOK:self._openproject});this.show(linb([document.body]))})};if(this.curProject){this._closeproject(callback)}else{callback()}break;case"closeproject":if(!this.curProject){linb.message(linb.getRes("VisualJS.ps.noprj"));return }this._closeproject();break;case"openproject":var callback=function(){linb.ComFactory.getCom("prjSel",null,function(){this.host=self;this.setProperties({caption:linb.getRes("VisualJS.dialog.select"),icon:"img/App.gif",iconPos:"-48px top",fromRegion:linb(src).getRegion(true),onOK:self._openproject});this.show(linb([document.body]))})};if(this.curProject){this._closeproject(callback)}else{callback()}break;case"saveall":if(!this.curProject){linb.message(linb.getRes("VisualJS.ps.noprj"));return }var tb=this.tabsMain,count=0,err;var items=tb.getItems();items.each(function(o){if(o._dirty){count++;var newText=o.$obj.getText();if(false===newText){err="err";return false}linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"save",hashCode:_.id(),path:o.id,content:newText}}),function(txt){if(_.unserialize(txt).OK){o.$obj.resetEnv(newText);tb.markDirty(o,false,true)}},function(txt){linb.message(txt)},null,{method:"POST"})}},this);if(!err){if(count){linb.message(linb.getRes("VisualJS.ps.saved",count))}else{linb.message(linb.getRes("VisualJS.ps.noSaved"))}}break;case"ec":linb.reLang(linb.lang=="en"?"cn":"en",function(){self.menubar.reset()});break;case"flash":linb.dom.submit("http://linb.googlecode.com/files/video.html");break;case"demo":linb.dom.submit("demo.html");break;case"info":if(!this.Message.length){return }var list=this.$infoList,node=list.reBoxing();list.setItems(this.Message.copy());node.popToTop(src,null,4);var unFun=function(){node.hide();linb.event.hookKey("esc",0,0,0,null)};node.setBlurTrigger(list.get(0).$id,unFun);linb.event.hookKey("esc",0,0,0,unFun);break;case"debug":if(!this.curProject){linb.message(linb.getRes("VisualJS.ps.noprj"));return }linb.dom.submit(this.curProject);break;case"release":if(!this.curProject){linb.message(linb.getRes("VisualJS.ps.noprj"));return }this.proxy.submit(CONF.phpPath,{key:CONF.requestKey,para:{path:this.curProject,action:"release"}},null,"POST");break;case"forum":linb.dom.submit("http://groups.google.com/group/linb");break;case"download":linb.dom.submit("http://code.google.com/p/linb/downloads/list");break;case"gpllicense":linb.dom.submit("http://www.gnu.org/licenses/gpl-3.0.txt");break;case"clicense":linb.dom.submit("license.txt");break;case"purchase":linb.dom.submit("http://linb.googlecode.com/files/purchase.html");break;case"about":linb.ComFactory.getCom("about",null,function(){this.show(linb([document.body]))});break;default:linb.message(linb.getRes("VisualJS.soon"))}}},Initialize:function(){linb.BookMark.hookLinkClick(null);window.onbeforeunload=function(e){if(linb.browser.ie6&&linb.temp.cancelBeforeload){delete linb.temp.cancelBeforeload;return }return" "}}});Class("VisualJS.PageEditor","linb.Com",{Instance:{iniUI:function(){var self=this;if(self.properties.checkType!="js"){self.toolbar.hideItem("check")}self.setText(self.properties.text)},eval2:function(txt){var r=true,iframe=document.createElement("iframe");iframe.style.display="none";document.body.appendChild(iframe);frames[frames.length-1].document.write("<script>var Class=function(a,b,c){}, _={}, linb={};var MSIE/*@cc_on =1@*/;parent.sandbox=MSIE?this:{eval:function(s){return eval(s)}}<\/script>");txt=txt.trim();try{try{sandbox.eval(txt)}catch(a){sandbox.eval("("+txt+")")}}catch(e){linb.message(_.Error(e));r=false}finally{document.body.removeChild(iframe)}return r},check:function(txt){switch(this.properties.checkType){case"js":return this.eval2(txt);break}return true},getText:function(flag){var self=this,txt=self.texteditor.getUIValue().replace(/\r\n/g,"\n");if(self.properties.text!=txt){if(false!==flag){if(self.check(txt)===false){return false}}return txt}else{return self.properties.text}},activate:function(){if(this.texteditor){var self=this;_.asyRun(function(){self.texteditor.activate();self=null})}},setReadonly:function(b){this.texteditor.setReadonly(b)},setText:function(txt,flag){var self=this;txt=txt||"";self.properties.text=txt.replace(/\r\n/g,"\n");self.texteditor.setValue(txt,true);self._dirty=false;return self},resetEnv:function(text){this._dirty=false;this.properties.text=text||txt.replace(/\r\n/g,"\n")},_texteditor_onKeyPress:function(profile,e,src){var self=this,ov=self._dirty,a,b,r=src.value.replace(/\r\n/g,"\n");self._dirty=self.properties.text!==r;if(ov!=self._dirty){_.tryF(self.events.onValueChanged,[self,profile,self._dirty,r],self.host)}},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Panel).host(t,"panel").setDock("fill"));t.panel.attach((new u.ToolBar).host(t,"toolbar").setItems([{id:"only",sub:[{id:"format",caption:"$VisualJS.pageEditor.format",icon:"img/App.gif",iconPos:"-32px -48px",type:"button",tips:"$VisualJS.pageEditor.formattips"},{id:"check",caption:"$VisualJS.pageEditor.check",icon:"img/App.gif",iconPos:"0 -48px",type:"button",tips:"$VisualJS.pageEditor.checktips"}]}]).onClick("_toolbar_onclick"));t.panel.attach((new u.TextEditor).host(t,"texteditor").setDock("fill").setCaption("texteditor").onKeyPress("_texteditor_onKeyPress"));return n},_toolbar_onclick:function(profile,id){var self=this;linb.dom.UIAction(function(){switch(id){case"format":var code=linb.coder.parse(self.texteditor.getUIValue(),self.properties.checkType,["plain"]);var dialog=new linb.UI.Dialog();dialog.setLeft(100).setTop(100).setWidth(300).setHeight(200).setStatus("max").setMinBtn(false).setMaxBtn(false).setCaption("$VisualJS.pageEditor.formatted").create();dialog.html(code);dialog.show(linb(document.body),true);break;case"check":var txt=self.getText();if(txt!==false){linb.message(linb.getRes("VisualJS.checkOK"))}break}})}}});Class("VisualJS.ClassTool",null,{Static:{isClassText:function(str){var reg=new RegExp("^(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)");while(reg.test(str)){str=str.replace(reg,"")}return/^\s*Class\(/.test(str)},getClassObject:function(str){str=str.slice(str.indexOf("{")+1,str.lastIndexOf("}"));return eval("({"+str+"})")},getCodeFromStruct:function(o){try{var self=arguments.callee,arr=[];if(o){if(o.sub){if(o.frame){_.each(o.sub,function(o,i){if(!_.isNull(o.comments)){arr.push((o.comments||"")+i+":"+(o.code?o.code:o.sub?self.call(this,o):""))}},this);return o.frame.replace("*1",o.name||"").replace("*2",o.pname||"").replace("*3",arr.join(",").replace(/\$/g,"$$$"))}else{return""}}else{return(o.code||"").replace(/^[\r\n]*/,"")}}else{return""}}catch(e){linb.message(linb.getRes("VisualJS.classtool.err2"))+":"+_.Error(e);return false}},parseSingleBlock:function(txt){try{var reg1=new RegExp("^(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)"),reg2=new RegExp("(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)$"),str,comments,code;while(reg2.test(txt)){txt=txt.replace(reg2,"")}str=txt;while(reg1.test(str)){str=str.replace(reg1,"")}str=str.replace(/\s*/,"");if(!str){return{comments:null,code:null}}comments="\n"+txt.replace(str,"");code=str.replace(/\s*$/,"");str=linb.coder.replace(str,[["(^|\\n)\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*",""],["\\n\\s*\\/\\/[^\\n]*\\s*",""],[/\s+(\/[^\/\n\r\*][^\/\n\r]*\/m?g?i?)\s*[:,;\r\n]/,""],[/[^\w\x24\/'"*)\]\?:]\/[^\/\n\r\*][^\/\n\r]*\/m?g?i?\s*[:,;\r\n]/,""]]);code=code.replace(/([}\]])[^}\]]*$/,"$1");str=linb.coder.replace(code,[["'(\\\\.|[^'\\\\])*'",""],['"(\\\\.|[^"\\\\])*"',""]]);while(/(\{([^\{\}]*)\})|(\[([^\[\]]*)\])/.test(str)){str=str.replace(/\s*(((function\s*([\w$]+\s*)?\(\s*([\w$\s,]*)\s*\)\s*)?(\{([^\{\}]*)\}))|(\[([^\[\]]*)\]))/g,"")}if(str.trim()!=""){return false}return{comments:comments,code:code}}catch(e){linb.message(linb.getRes("VisualJS.classtool.err3")+":"+_.Error(e));return false}},getClassStruct:function(str){str=str.replace(/(\r\n|\r)/g,"\n").replace(/( +)(\n)/g,"$2").replace(/\t/g,"    ");var t,index=1,index1=1,cache={},cache1={},result,result2,code=function(str,i){var ret="#"+(index++)+"#";cache[ret]=str[0];return ret},code1=function(str){var ret="`"+(index1++);cache1[ret]=str[0];return ret},restore=function(str){return str.replace(/#(\d+)#/g,function(m){return cache[m]})},restore1=function(str){return str.replace(/`(\d+)/g,function(m){return cache1[m]})};str=linb.coder.replace(str,[["(^|\\n)\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/[^\\n]*",code],["(^|\\n)\\s*\\/\\/[^\\n]*",code],[/\s+(\/[^\/\n\r\*][^\/\n\r]*\/m?g?i?)\s*[:,;\r\n]/,code],[/[^\w\x24\/'"*)\]\?:]\/[^\/\n\r\*][^\/\n\r]*\/m?g?i?\s*[:,;\r\n]/,code]]);str=linb.coder.replace(str,[["'(\\\\.|[^'\\\\])*'",code1],['"(\\\\.|[^"\\\\])*"',code1]]);var frame=str.replace(/(^[^{]*\{)\s*((.|[\r\n])*)([^\s])(\s*}[^}]*$)/,"$1*3$5").replace(/(#\d+#)+/g,""),o={sub:{}};if(t=str.match(/^((#\d+#)+)/)){o.comments=restore(t[0])}else{o.comments=""}t=str.split(",");o.name=restore1(cache1["`1"].replace(/[\'\" ]*/g,""));o.pname=restore(restore1(t[1]).replace(/[\'\" ]*/g,""));o.frame=restore1(frame.replace(o.name,"*1").replace(o.pname,"*2"));str=str.slice(str.indexOf("{")+1,str.lastIndexOf("}"));result=o.sub;var index2=1,cache2={},code2=function(str){var ret="'~"+index2+++"'";cache2[ret]=str;return ret},code3=function(a,b,str){if(a.indexOf("~")!=-1){return a}var ret="'~"+index2+++"'";cache2[ret]=str;return b+ret},restore2=function(str){if(str.indexOf("~")==-1){return str}str=cache2["'"+str+"'"];while(/'~\d+'/.test(str)){str=str.replace(/'~\d+'/g,function(m){return cache2[m]})}return str};while(/(\{([^\{\}]*)\})|(\[([^\[\]]*)\])/.test(str)){str=str.replace(/\s*(((function\s*([\w$]+\s*)?\(\s*([\w$\s,]*)\s*\)\s*)?(\{([^\{\}\[\]]*)\}))|(\[([^\[\]\{\}]*)\]))/g,code2)}str=linb.coder.replace(str,["\\s+",code]);str=str.replace(/((#\d+#)+)([\w]+)((#\d+#)*):/g,function(z,a,b,c){result[c]={comments:restore(a)};return c+":"});str=str.replace(/(#\d+#)/g,"");var obj=eval("({"+str+"})");["Constructor","Initialize","Before","After"].each(function(i){if(obj[i]){result[i]=result[i]||{};result[i].code=restore(restore1(restore2(obj[i])))}else{result[i]={}}"code,comments".toArr().each(function(j){result[i][j]=_.exists(result[i][j])?result[i][j]:null})});var obj2;["Instance","Static"].each(function(i){if(obj[i]){var temp=cache2["'"+obj[i]+"'"];var frame=temp.replace(/(^[^{]*\{)\s*((.|[\r\n])*)([^\s])(\s*}[^}]*$)/,"$1*3$5");temp=temp.replace(/(#\d+#)*\s*(\})$/g,"$2");temp="("+temp+")";temp=linb.coder.replace(temp,["\\s+",code]);result[i]=result[i]||{};result2=result[i].sub={};result[i].frame=frame;temp=temp.replace(/(:)([^,\}]+)/g,code3);temp=restore1(temp);temp=temp.replace(/((#\d+#)+)([\w]+)((#\d+#)*):/g,function(z,a,b,c){result2[c]={comments:restore(a)};return c+":"});temp=temp.replace(/(#\d+#)/g,"");obj2=eval(temp);_.each(obj2,function(o,j){result2[j]=result2[j]||{};result2[j].code=restore(restore1(restore2(o)))})}else{result[i]={}}"code,comments,sub,frame".toArr().each(function(j){result[i][j]=_.exists(result[i][j])?result[i][j]:null})});return o}}});Class("VisualJS.ClassEditor","linb.Com",{Instance:{views:null,events:{afterCreated:function(page,threadid){var self=page;page.views={};linb.ComFactory.newCom("VisualJS.PageEditor",function(){var inn=this;inn.host=page;inn.setProperties({text:page.properties.text,checkType:"js"});inn.setEvents("onValueChanged",function(ipage,profile,b,r){_.tryF(page.events.onValueChanged,[page,ipage,self.properties.textO!=r],page.host)});inn.show(null,page.buttonview,"normal");page.views.normal=inn},threadid)}},activate:function(){var self=this,t;if(!self.views){return }var view=self.buttonview.getUIValue();if(t=self.views[view]){if(t.created){t.activate()}}},beforeDestroy:function(){_.each(this.views,function(o){o.destroy()})},getText:function(){var view=this.buttonview.getUIValue();return this.views[view].getText()},setText:function(txt,flag){var self=this,p=self.properties;txt=txt.replace(/\r\n/g,"\n");p.textO=p.text=txt;p.clsStruct=p.clsObject=null;self.views[self.buttonview.getUIValue()].setText(txt,flag);return self},resetEnv:function(text){var self=this,p=self.properties;if(!text){text=self.getText()}p.clsStruct=p.clsObject=null;p.textO=p.text=text;self.views[self.buttonview.getUIValue()].resetEnv(text)},_buttonview_aftercreated:function(profile){profile.getSubNode("PANEL",true).setStyle({borderBottom:"0",borderLeft:"0",borderRight:"0"})},_buttonview_beforeValueUpdated:function(profile,ov,nv){var self=this,p=self.properties,t;if(!self.views){return }if((t=self.views[ov])&&t.created){var r=t.getText();if(false===r){return false}else{if(ov=="normal"){if(!VisualJS.ClassTool.isClassText(r)){p.clsStruct=p.clsObject=null;linb.message(linb.getRes("VisualJS.classtool.noClass"));return false}}if(p.text!=r||!p.clsStruct||!p.clsObject){try{p.clsStruct=VisualJS.ClassTool.getClassStruct(r);p.clsObject=VisualJS.ClassTool.getClassObject(r)}catch(e){p.clsStruct=p.clsObject=null;linb.message(linb.getRes("VisualJS.classEditor.codeerr",_.Error(e)));return false}p.text=r}if(ov!="normal"){var pp=t.properties;pp.text=r;pp.clsStruct=p.clsStruct;pp.clsObject=p.clsObject}}}else{return false}},_buttonview_onitemselected:function(profile,item,src){var self=this,p=self.properties,t;if(!self.views){return }if(!(t=self.views[item.id])){if(item.id=="struct"){linb.ComFactory.newCom("VisualJS.ClassStruct",function(){this.setHost(self).setProperties({text:p.text,clsStruct:p.clsStruct,clsObject:p.clsObject}).setEvents({onValueChanged:function(ipage,profile,b){_.tryF(self.events.onValueChanged,[this,ipage,(p.textO!=p.text)||b],self.host)}});this.show(null,self.buttonview,"struct");self.views.struct=this})}else{if(item.id=="design"){linb.ComFactory.newCom("VisualJS.Designer",function(){this.setHost(self).setProperties({$design:p.$design,text:p.text,clsStruct:p.clsStruct,clsObject:p.clsObject}).setEvents({onValueChanged:function(ipage,profile,b){_.tryF(self.events.onValueChanged,[this,ipage,(p.textO!=p.text)||b],self.host)}});this.show(null,self.buttonview,"design");self.views.design=this})}}}else{linb([src],false).UIAction(function(threadid){if(t.created){if(item.id=="struct"||item.id=="design"){t.properties.clsStruct=p.clsStruct;t.properties.clsObject=p.clsObject}t.setText(p.text,false,threadid).activate()}})}},base:["linb.UI"],required:["linb.UI.Tabs","linb.UI.ButtonViews","VisualJS.ClassTool"],parepareData:function(properties){properties.textO=properties.text},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.ButtonViews).host(t,"buttonview").setLeft(0).setTop(0).setItems([{id:"normal",caption:"$VisualJS.classEditor.nv",icon:"img/App.gif",iconPos:"-80px -48px",tips:"$VisualJS.classEditor.nvtips"},{id:"struct",caption:"$VisualJS.classEditor.sv",icon:"img/App.gif",iconPos:"-32px -48px",tips:"$VisualJS.classEditor.svtips"},{id:"design",caption:"$VisualJS.classEditor.dv",icon:"img/App.gif",iconPos:"-192px -48px",tips:"$VisualJS.classEditor.dvtips"}]).setValue("normal").setHandleSize("28").beforeValueUpdated("_buttonview_beforeValueUpdated").afterCreated("_buttonview_aftercreated").onItemSelected("_buttonview_onitemselected"));return n}}});Class("VisualJS.ClassStruct","linb.Com",{Instance:{events:{afterShow:function(page){page.setText(page.properties.text,true)}},iniExComs:function(threadid){var self=this;linb.ComFactory.newCom("VisualJS.PageEditor",function(){var inn=this;inn.host=self;inn.setProperties({checkType:"js"});inn.setEvents("onValueChanged",function(ipagprofile,e,b){_.tryF(self.events.onValueChanged,[ipagprofile,e,self.$dirty||b],self.host)});inn.show(null,self.layoutFill,"main");self.PageEditor=inn},threadid)},activate:function(){this.PageEditor.activate()},check:function(txt){return this.PageEditor.check(txt)},getText:function(){var self=this,p=self.properties,r=self.refer,txt=self.PageEditor.getText(false);if(txt===false){return false}if(self.$dirty||p.temptext!=txt){if(r){if(false===self.check(txt)){return false}var result=VisualJS.ClassTool.parseSingleBlock(txt);if(false===result){linb.message(linb.getRes("VisualJS.classtool.err1"));return false}p.temptext=txt;r.comments=result.comments;r.code=result.code;txt=VisualJS.ClassTool.getCodeFromStruct(p.clsStruct);return p.clsStruct.comments.replace(/^[\r\n]*/,"")+txt}}return p.text},setText:function(txt,flag){var self=this,p=self.properties;txt=txt.replace(/\r\n/g,"\n");if(flag||p.text!=txt){p.text=txt;var clsStruct=p.clsStruct,clsObject=p.clsObject;value=self.treebarClass.getUIValue();self.treebarClass.setValue(null,true);var items=[{id:"Class",caption:"Class",caption:clsStruct.name,icon:"img/App.gif",iconPos:"-16px -48px",group:true,sub:[{id:"Constructor",caption:"Constructor",icon:"img/App.gif",iconPos:"-32px -32px"},{id:"Instance",caption:"Instance",icon:"img/App.gif",iconPos:"-16px -32px",sub:[]},{id:"Static",caption:"Static",icon:"img/App.gif",iconPos:"-16px -32px",sub:[]},{id:"Initialize",caption:"Initialize",icon:"img/App.gif",iconPos:"-32px -32px"},{id:"Before",caption:"Before",icon:"img/App.gif",iconPos:"-32px -32px"},{id:"After",caption:"After",icon:"img/App.gif",iconPos:"-32px -32px"}]}];var t,m,icon,j=items[0].sub;t=p.clsStruct.sub;if(t){m=t.Instance;if(m&&(m=m.sub)){_.each(m,function(o,i){icon="img/App.gif";iconPos=(typeof clsObject.Instance[i]=="function")?"-32px -32px":"0 -32px";if(_.isHash(clsObject.Instance[i])){icon="block.gif"}j[1].sub.push({id:"Instance."+i,caption:i,icon:icon,iconPos:iconPos})})}m=t.Static;if(m&&(m=m.sub)){_.each(m,function(o,i){icon=(typeof clsObject.Static[i]=="function")?"function.gif":"property.gif";if(_.isHash(clsObject.Static[i])){icon="block.gif"}j[2].sub.push({id:"Static."+i,caption:i,icon:"img/"+icon})})}}delete self.refer;self.treebarClass.setItems(items);if(value){if(self.treebarClass.selectItem(value)){return self}}self.PageEditor.setText("").setReadonly(true)}self.resetEnv(txt);return self},resetEnv:function(text){var self=this;if(!text){text=self.getText()}self.$dirty=false;self.properties.text=text;self.PageEditor.resetEnv(text)},_treebarclass_beforevalueupdated:function(profile,ov,nv){var self=this,p=self.PageEditor;if(!self.refer){return }var txt=p.getText();if(txt===false){return false}if(self.properties.temptext!=txt){if(false===self.check(txt)){return false}var result=VisualJS.ClassTool.parseSingleBlock(txt);if(false===result){linb.message(linb.getRes("VisualJS.classtool.err1"));return false}self.refer.comments=result.comments;self.refer.code=result.code;self.$dirty=true}},_treebarclass_onitemselected:function(profile,item,node){if(!item.id){return }var self=this,p=self.PageEditor,value=item.id;linb([node],false).UIAction(function(threadid){var o=self.properties.clsStruct,t,m,arr;var comments,code;switch(value){case"Class":code=VisualJS.ClassTool.getCodeFromStruct(o);break;case"Static":case"Instance":case"Constructor":case"Initialize":case"Before":case"After":o=o.sub;if(o=o[value]){if(o.sub){code=VisualJS.ClassTool.getCodeFromStruct(o)}}break;default:o=o.sub;arr=value.split(".");o=o[arr[0]];o=o.sub;o=o[arr[1]]}comments=(o?(o.comments||""):"");if(comments){comments=comments.replace(/^[\r\n]*/,"")}code=code||(o&&o.code)||"";linb.thread.suspend(threadid);var t=linb([node],false).getRegion(true),pro=p.texteditor.reBoxing().getRegion(true);linb.dom.fxProxy(t,pro,null,function(){p.setText(self.properties.temptext=comments+code).activate();p.setReadonly(value=="Class"||value=="Instance"||value=="Static")},240,8,"inexp").start();self.refer=o;linb.thread.resume(threadid)})},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Layout).host(t,"layoutFill").setLeft(0).setTop(0).setItems([{id:"before",pos:"before",locked:false,size:150,min:50,max:200,cmd:false}]).setType("horizontal"));t.layoutFill.attach((new u.TreeBar).host(t,"treebarClass").setLeft(0).setTop(0).setGroup(false).setItems([]).setIniFold(false).onItemSelected("_treebarclass_onitemselected").beforeValueUpdated("_treebarclass_beforevalueupdated"),"before");return n}}});Class("VisualJS.ObjectEditor","linb.Com",{Instance:{iniExComs:function(threadid){var self=this;linb.ComFactory.newCom("VisualJS.PageEditor",function(){var inn=this;inn.host=self;inn.setProperties({checkType:"js"});inn.show(null,self.dialog,null,threadid);self.PageEditor=inn},threadid)},check:function(txt){return this.PageEditor.check(txt)},_dialog_beforeclose:function(profile){this.dialog.hide();return false},_btncancel_onclick:function(){this.dialog.close()},_btnok_onclick:function(){var self=this,prop=self.properties,txt=self.PageEditor.getText(false);if(txt===false){return false}if(prop.text!=txt){if(false===self.check(txt)){return false}prop.result=VisualJS.ClassTool.parseSingleBlock(txt);if(false===prop.result){linb.message(linb.getRes("VisualJS.classtool.err1"));return false}prop.text=txt;prop.object=_.unserialize(prop.text)||null;_.tryF(prop.onOK,[self],self.host)}self.dialog.close()},customAttach:function(parent){var page=this,prop=page.properties,dlg=page.dialog;dlg.setCaption(prop.caption).setIcon(prop.icon).setIconPos(prop.iconPos);page.PageEditor.setText(prop.text);if(prop.fromRegion){dlg.setFromRegion(prop.fromRegion)}if(!dlg.get(0).root){dlg.create()}dlg.show(parent,true);return false},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Dialog).host(t,"dialog").setLeft(216).setTop(80).setWidth(500).setMaxBtn(false).setMinBtn(false).setCaption("dialog").beforeClose("_dialog_beforeclose"));t.dialog.attach((new u.Panel).host(t,"panelB").setDock("bottom").setHeight(35));t.panelB.attach((new u.Panel).host(t,"panelR").setDock("right").setWidth(284));t.panelR.attach((new u.Button).host(t,"btnCancel").setLeft(64).setTop(8).setWidth("100").setCaption("Cancel").setIcon("img/App.gif").setIconPos("-16px -16px").onClick("_btncancel_onclick"));t.panelR.attach((new u.Button).host(t,"btnOK").setLeft(176).setTop(8).setWidth("100").setCaption("OK").setIcon("img/App.gif").setIconPos("-64px -16px").onClick("_btnok_onclick"));return n}}});Class("VisualJS.ProjectPro","linb.Com",{Instance:{customAttach:function(){var self=this,prop=self.properties;self.dialog.setCaption(prop.caption).setIcon(prop.icon).setIconPos(prop.iconPos);self.inputName.setValue(prop.projectName,true);self.inputClassName.setValue(prop.className,true);self._refreshLabel(prop.projectName);if(prop.fromRegion){self.dialog.setFromRegion(prop.fromRegion)}self.inputName.setDisabled(prop.readonly);self.inputClassName.setDisabled(prop.readonly);self.dialog.show(self.parent,true)},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Dialog).host(t,"dialog").setLeft(100).setTop(100).setWidth(540).setHeight(220).setMinBtn(false).setMaxBtn(false).setResizable(false).setCaption("dialog").onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));t.dialog.attach((new u.Input).host(t,"inputName").setLeft(126).setTop(16).setTipsErr("$VisualJS.projectPro.onlyword").setValueFormat("^\\w{3,15}$").afterValueUpdated("_inputname_aftervalueupdated"));t.dialog.attach((new u.Label).host(t,"label1").setLeft(14).setTop(18).setWidth(104).setCaption("$VisualJS.projectPro.name"));t.dialog.attach((new u.Label).host(t,"label3").setLeft(30).setTop(82).setWidth(88).setCaption("$VisualJS.projectPro.classfile"));t.dialog.attach((new u.Label).host(t,"label5").setLeft(38).setTop(50).setWidth(80).setCaption("$VisualJS.projectPro.class"));t.dialog.attach((new u.Button).host(t,"btnCancel").setLeft(262).setTop(152).setWidth(90).setTabindex("0").setCaption("$VisualJS.cancel").setIcon("img/App.gif").setIconPos("-16px -16px").onClick("_btncancel_onclick"));t.dialog.attach((new u.Input).host(t,"inputClassName").setLeft(126).setTop(48).setValueFormat("^\\w{3,15}$").setTipsErr("$VisualJS.projectPro.onlyword"));t.dialog.attach((new u.Label).host(t,"label7").setLeft(126).setTop(114).setWidth(384).setHAlign("left").setCaption("label7"));t.dialog.attach((new u.Label).host(t,"label2").setLeft(30).setTop(114).setWidth(88).setCaption("$VisualJS.projectPro.pagefile"));t.dialog.attach((new u.Label).host(t,"label8").setLeft(126).setTop(82).setWidth(384).setHAlign("left").setCaption("label8"));t.dialog.attach((new u.Button).host(t,"btnOK").setLeft(374).setTop(152).setWidth(90).setCaption("$VisualJS.ok").setIcon("img/App.gif").setIconPos("-64px -16px").onClick("_btnok_onclick"));return n},_dialog_beforeclose:function(profile){this.dialog.hide();return false},_btncancel_onclick:function(){this.dialog.close()},_btnok_onclick:function(){var self=this;if(self.inputName.checkUIValueValid()===false||self.inputClassName.checkUIValueValid()===false){linb.message(linb.getRes("VisualJS.projectPro.invalid"));return }var pm=self.projectName=self.inputName.updateValue().getValue();self.className=self.inputClassName.updateValue().getValue();linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"new",hashCode:_.id(),path:this.projectName,className:this.className}}),function(txt){var obj=_.unserialize(txt);if(!obj||obj.error){linb.message(txt)}else{_.tryF(self.properties.onOK,["projects/"+pm,obj],self.host)}self.dialog.close()},function(txt){linb.message(txt)})},_inputname_aftervalueupdated:function(profile,oldValue,newValue){this._refreshLabel(newValue)},_refreshLabel:function(prjname,filename){var self=this;filename=filename||"index";self.label7.setCaption(linb.ini.appPath+"projects/"+prjname+"/"+filename+".html");self.label8.setCaption(linb.ini.appPath+"projects/"+prjname+"/VisualJS/js/"+filename+".js")},_dialog_onhotkey:function(profile,key,control,shift,alt){if(key=="esc"){profile.boxing().close()}}}});Class("VisualJS.ProjectSelector","linb.Com",{Instance:{customAttach:function(){var self=this,dlg=self.dialog,prop=self.properties;dlg.setCaption(prop.caption).setIcon(prop.icon).setIconPos(prop.iconPos);self.listName.setUIValue("").setItems([]);if(prop.fromRegion){dlg.setFromRegion(prop.fromRegion)}dlg.show(self.parent,true);linb.dom.setCover(linb.getRes("VisualJS.ps.getting"));linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"open",hashCode:_.id(),path:"projects",deep:"0"}}),function(txt){var arr=_.unserialize(txt);if(!arr||arr.error){linb.message(txt)}else{if(arr&&arr.length){self.properties.projectList=[];arr.each(function(i){if(i.type===0){self.properties.projectList.push({id:i.location,caption:i.name})}})}self.listName.setItems(prop.projectList);linb.dom.setCover(false)}},function(){linb.dom.setCover(false)})},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Dialog).host(t,"dialog").setLeft(100).setTop(100).setWidth(340).setHeight(190).setMinBtn(false).setMaxBtn(false).setResizable(false).setCaption("dialog").onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));t.dialog.attach((new u.List).host(t,"listName").setDock("top").setHeight(120).setItems([]));t.dialog.attach((new u.Button).host(t,"btnCancel").setLeft(140).setTop(130).setWidth(90).setZIndex("1").setCaption("$VisualJS.cancel").setIcon("img/App.gif").setIconPos("-16px -16px").onClick("_btncancel_onclick"));t.dialog.attach((new u.Button).host(t,"btnOK").setLeft(230).setTop(130).setWidth(90).setZIndex("1").setCaption("$VisualJS.ok").setIcon("img/App.gif").setIconPos("-64px -16px").onClick("_btnok_onclick"));return n},_btncancel_onclick:function(){this.dialog.close()},_btnok_onclick:function(){var self=this,pm=self.projectName=self.listName.getUIValue();if(!self.projectName){linb.message(linb.getRes("VisualJS.ps.noselected"));return }linb.request(CONF.phpPath,_.serialize({key:CONF.requestKey,para:{action:"open",hashCode:_.id(),path:this.projectName}}),function(txt){var obj=_.unserialize(txt);if(!obj||obj.error){linb.message(txt)}else{_.tryF(self.properties.onOK,[pm,obj],self.host)}self.dialog.close()})},_dialog_beforeclose:function(profile){this.dialog.hide();return false},_dialog_onhotkey:function(profile,key,control,shift,alt){if(key=="esc"){profile.boxing().close()}}}});Class("VisualJS.Designer","linb.Com",{Instance:{panelHeight:600,panelWidth:800,dropPosition:"absolute",dropOffset:10,events:{afterShow:function(page,threadid){var tbpath="img/designer/toolbar.gif",tbk="$VisualJS.designer.tool.";page.proxy=linb.create('<div style="position:absolute;border:dashed 1px blue;overflow:visible;left:-100px;top:-100px;z-index:1000"></div>');page.resizer=linb.create("Resizer",{dragArgs:{grid_width:this.dropOffset,grid_height:this.dropOffset},zIndex:linb.dom.top_zIndex});page.resizer.host(page).onItemsSelected(function(profile,ids){this.pProfile.setSelectFromResizer.call(this.pProfile,ids)}).onActive(function(profile){this._focus()}).onUpdate(function(profile,target,size,cssPos){page._change();var self=this;if(target){var b=false;target.each(function(target){target=linb([target],false);var profile=linb.cache.dom[target.get(0).id],widget=profile.boxing(),p=profile.properties,m=profile.box.getDataModel();if(size){var w=null,h=null;if(size.width){if(p&&!m.width){b=true}else{switch(p.dock){case"top":case"bottom":case"fill":case"cover":case"width":b=true;break;case"left":case"right":case"height":b=true;default:target.widthBy(size.width,true);w=widget.refreshWidth()}}}if(size.height){if(p&&!m.height){b=true}else{switch(p.dock){case"left":case"right":case"fill":case"cover":case"height":b=true;break;case"top":case"bottom":case"width":b=true;default:target.heightBy(size.height,true);h=widget.refreshHeight()}}}self._sizeUpdated(target,{width:w,height:h})}if(cssPos){var x=null,y=null;if(cssPos.left){if(p&&!m.left){b=true}else{switch(p.dock){case"top":case"bottom":case"left":case"right":case"fill":case"cover":case"width":b=true;break;case"height":b=true;default:target.leftBy(cssPos.left);x=widget.refreshLeft()}}}if(cssPos.top){if(p&&!m.top){b=true}else{switch(p.dock){case"left":case"right":case"top":case"bottom":case"fill":case"cover":case"height":b=true;break;case"width":b=true;default:target.topBy(cssPos.top);y=widget.refreshTop()}}}self._posUpdated(target,{left:x,top:y})}});if(b){profile.boxing().rePosSize()}}}).onFocusChange(function(profile,index){if(this.tempSelected){this.SelectedFocus=index;_.resetRun("$profilegrid$",this._refreshProfileGrid,0,[this.tempSelected],this)}}).onRegionClick(function(profile,e){var ep=linb.event.getPos(e),arr,t,m,ret;var fun=function(arr,ep,parent){var me=arguments.callee,m,rt,pos,w,h,epoff={},ppos=parent.absPos(),rgw=parent.offsetWidth(),rgh=parent.offsetHeight();epoff.left=ep.left-ppos.left;epoff.top=ep.top-ppos.top;arr.each(function(o){if(m=o[0].root){if(o[0].children.length){if(rt=me(o[0].children,ep,m)){return false}}pos=m.absPos(null,parent);w=m.offsetWidth();h=m.offsetHeight();if(epoff.left>pos.left&&epoff.top>pos.top&&epoff.left<pos.left+w&&epoff.top<pos.top+h&&epoff.left<rgw&&epoff.top<rgh){rt=o[0].$id;return false}}});return rt};if(!(arr=this.tempSelected)||!arr.length){return }arr.each(function(o){t=linb.UIProfile.getFromCacheId(o);ret=fun(t.children,ep,t.root);if(ret){return false}});if(ret){this.selectWidget([ret]);return false}});page.holder=linb.create('<div style="display:none;"></div>');page.panelDiv.reBoxing().addLast(page.holder);page.holder.addLast(page.resizer);page.holder.addLast(page.proxy);page.proxy.get(0).zIndexIgnore=true;page.toolbar.setItems([{id:"code",sub:[{id:"format",icon:"img/App.gif",iconPos:"-32px -48px",type:"button",tips:tbk+"tocode"},{id:"json",icon:"img/App.gif",iconPos:"-128px -64px",type:"button",tips:tbk+"tojson"}]},{id:"align",sub:[{id:"left",caption:"",icon:tbpath,iconPos:"0 top",tips:tbk+"left"},{id:"center",caption:"",icon:tbpath,iconPos:"-16px top",tips:tbk+"center"},{id:"right",caption:"",icon:tbpath,iconPos:"-32px top",tips:tbk+"right"},{id:"s1",type:"split"},{id:"top",caption:"",icon:tbpath,iconPos:"-48px top",tips:tbk+"top"},{id:"middle",caption:"",icon:tbpath,iconPos:"-64px top",tips:tbk+"middle"},{id:"bottom",caption:"",icon:tbpath,iconPos:"-80px top",tips:tbk+"bottom"},{id:"s2",type:"split"},{id:"w",caption:"",icon:tbpath,iconPos:"-96px top",tips:tbk+"width"},{id:"wh",caption:"",icon:tbpath,iconPos:"-112px top",tips:tbk+"wh"},{id:"h",caption:"",icon:tbpath,iconPos:"-128px top",tips:tbk+"height"}]},{id:"pos",sub:[{id:"zindex1",caption:"",icon:tbpath,iconPos:"-144px top",tips:tbk+"toplayer"},{id:"zindex2",caption:"",icon:tbpath,iconPos:"-160px top",tips:tbk+"bottomlayer"},{id:"s1",type:"split"},{id:"repos",caption:"",icon:tbpath,iconPos:"-176px top",tips:tbk+"gridxy"},{id:"resize",caption:"",icon:tbpath,iconPos:"-192px top",tips:tbk+"gridwh"},{id:"s2",type:"split"},{id:"clone",caption:"",icon:tbpath,iconPos:"-240px top",tips:tbk+"clone"}]},{id:"del",sub:[{id:"delete",caption:"",icon:tbpath,iconPos:"-256px top",tips:tbk+"delete"}]}]);page.treebarCom.setItems(_.clone(CONF.widgets)).setCustomBehavior({BAR:{onMousedown:function(profile,e,src){var id=src.id,itemId=profile.getSubSerialId(id),properties=profile.properties,item=profile.getItemByDom(id),pos=linb.event.getPos(e);if(item.dragable){profile.getSubNode("ICON",itemId).startDrag(e,{drop2:true,icon:linb.ini.path+"onDrag.gif",dragMode:"add",cursor:"pointer",target_left:pos.left+12,target_top:pos.top+12,move:false,key:item.dragKey||profile.properties.dragKey,data:{type:item.id,iconPos:item.iconPos}});profile.removeTagClass("BAR","-mouseover",linb([src]));page._clearSelect();page._setSelected([],true)}}}});page.focusBtn=linb.create('<a href="javascript;" style="position:absolute;left:-10000px;top:-10000px;width:1px;height:1px;">o</a>');page.focusBtn.onKeydown(function(pro,e,src){if(!page.resizer){return }var key=linb.event.getKey(e),k=key[0],ctrl=key[1],shift=key[2],step=1,o=page.resizer.reBoxing(),profile=page.resizer.get(0),cssPos=o.cssPos(),cssSize=o.cssSize(),gridh=profile.properties.dragArgs.grid_height,gridw=profile.properties.dragArgs.grid_width;var t,b=false,size=null,pos=null;switch(k){case"up":b=true;if(ctrl){step=-1}else{if(shift){step=(t=(cssPos.top+cssSize.height)%gridh)?-t:-gridh}else{step=(t=cssPos.top%gridh)?-t:-gridh}}if(shift){o.heightBy(step);profile.regions.heightBy(step);size={width:0,height:step}}else{o.topBy(step);pos={left:0,top:step}}break;case"down":b=true;if(ctrl){step=1}else{if(shift){step=(t=(cssPos.top+cssSize.height)%gridh)?gridh-t:gridh}else{step=(t=cssPos.top%gridh)?gridh-t:gridh}}if(shift){o.heightBy(step);profile.regions.heightBy(step);size={width:0,height:step}}else{o.topBy(step);pos={left:0,top:step}}break;case"left":b=true;if(ctrl){step=-1}else{if(shift){step=(t=(cssPos.left+cssSize.width)%gridw)?-t:-gridw}else{step=(t=cssPos.left%gridw)?-t:-gridw}}if(shift){profile.regions.widthBy(step);o.widthBy(step);size={width:step,height:null}}else{o.leftBy(step);pos={left:step,top:0}}break;case"right":b=true;if(ctrl){step=1}else{if(shift){step=(t=(cssPos.left+cssSize.width)%gridw)?gridw-t:gridw}else{step=(t=cssPos.left%gridw)?gridw-t:gridw}}if(shift){o.widthBy(step);profile.regions.widthBy(step);size={width:step,height:null}}else{o.leftBy(step);pos={left:step,top:0}}break;case"delete":page._deleteSelected();page._focus();break;case"esc":page._clearSelect();page._setSelected([],true);break}if(b){profile.boxing().onUpdate(profile,profile._target,size,pos);return false}}).onFocus(function(pro,e,src){clearTimeout(page.timer);page.resizer.active(false)}).onBlur(function(pro,e,src){page.timer=_.asyRun(function(){if(page.resizer){page.resizer.inActive()}},200)});page.layoutBase.reBoxing().addFirst(page.focusBtn);page._enablePanelDesign(page.canvas.get(0));page.setText(page.properties.text,true,threadid)},onSelected:function(page,profile,ids){var v=null,id=ids&&ids[ids.length-1];if(id){var o=linb.getObject(id);if(o){v=o}}page.listObject.setCtrlValue(v?v.alias:"page",true);_.resetRun("$profilegrid$",page._refreshProfileGrid,0,[ids],page)},onReady:function(page){page.canvas.setWidth(page.panelWidth).setHeight(page.panelHeight);page.panelBG.setWidth(page.panelWidth).setHeight(page.panelHeight)}},_detatchResizer:function(){var self=this;self.holder.addLast(self.resizer);self.holder.addLast(self.proxy);self.pProfile=self.pNode=null},_attachResizer:function(profile,node){var self=this;self.proxy.display("none");self.resizer.resetTarget(null,false);linb(node).addLast(self.resizer).addLast(self.proxy);self.pProfile=profile;self.pNode=node;_.merge(self.resizer.get(0).properties.dragArgs,{grid_width:self.dropOffset,grid_height:self.dropOffset},"all")},_focus:function(){this.focusBtn.focus()},_setSelected:function(ids,flag){var self=this,tb=self.toolbar,t;ids=_.arr(ids);self.tempSelected=ids;self.SelectedFocus=ids.length-1;tb.disableGroup("align",ids.length>1?false:true);if(ids.length>0&&(t=linb.UIProfile.getFromCacheId(ids[0]))){tb.disableGroup("pos",!t.box.hasDomRoot)}else{tb.disableGroup("pos",true)}tb.disableGroup("del",ids.length>0?false:true);if(flag){self.events.onSelected.apply(self.parent,[self,self.pProfile,ids])}self._focus();return self},_sizeUpdated:function(pro,size){var t,self=this;if(!(t=self.profileGrid.get(0).$widget)){return }if(linb.cache.dom[pro.get(0).id]==t.get(t.length()-1)){_.asyRun(function(){if(size.width!==null){self.profileGrid.updateCellbyRowCol("properties:width","value",size.width,true)}if(size.height!==null){self.profileGrid.updateCellbyRowCol("properties:height","value",size.height,true)}})}},_posUpdated:function(pro,cssPos){var t,self=this;if(!(t=self.profileGrid.get(0).$widget)){return }if(linb.cache.dom[pro.get(0).id]==t.get(t.length()-1)){_.asyRun(function(){if(cssPos.left!==null){self.profileGrid.updateCellbyRowCol("properties:left","value",cssPos.left,true)}if(cssPos.top!==null){self.profileGrid.updateCellbyRowCol("properties:top","value",cssPos.top,true)}})}},parseFun:function(txt){var str=txt;var reg=new RegExp("^(\\s*\\/\\*[^*@]*\\*+([^\\/][^*]*\\*+)*\\/\\s*)|^(\\s*\\/\\/[^\\n]*\\s*)");while(reg.test(str)){str=str.replace(reg,"")}str=str.replace(/\s*/,"");if(!str){return{comments:null,code:null}}if(false===this.check(str.replace(/\s*$/,""))){return false}return{comments:"\n"+txt.replace(str,""),code:str.replace(/\s*$/,"")}},_designable:function(profile){var me=arguments.callee,self=this;self._giveHandler(profile);profile.properties.$design=self.properties.$design;if(linb.cache.$dropPool[profile.box.KEY]){self._enablePanelDesign(profile)}if(profile.children&&profile.children.length){profile.children.each(function(o){me.call(self,o[0])})}profile.$addOns=me;profile.$addOns.target=self},_WidgetsSelected:function(ids){var self=this;this._setSelected(ids,true);this.iconlist.updateUIValue(null)},_clearSelect:function(profile){this.resizer.resetTarget(null,false);this._detatchResizer();this.iconlist.updateUIValue(null)},_deleteSelected:function(){if(!this.tempSelected||!this.tempSelected.length){return }var page=this;linb.UI.Dialog.confirm(linb.getRes("VisualJS.designer.confirmdel"),linb.getRes("VisualJS.designer.confirmdel2",this.tempSelected.length),function(){var sel=linb.UI.getByCacheId(page.tempSelected);if(!sel.isEmpty()){var ids=[];var ws=linb.UI.getByCacheId(page.tempSelected);ws.each(function(o){if(!o.box.hasDomRoot){page.iconlist.removeItems(o.$id)}});ws.destroy()}else{var o=linb.getObject(page.tempSelected[0]);if(o.box["linb.DataSource"]){page.iconlist.removeItems(page.tempSelected)}o.boxing().destroy()}page._clearSelect(page.pProfile);page._setSelected(null,true)})},_giveHandler:function(target){var getRootId=function(id){var arr=id.split(":");return arr[0].split("-")[0]+":"+arr[1]+":"},prevent=function(){return };var page=this;target.root.beforeClick(prevent).afterClick(prevent).onClick(function(pro,e,src){var esrc=linb.event.getSrc(e),id=esrc.id;if(id==linb.langId){id=esrc.parentNode.id}if(getRootId(id)!=(id=getRootId(src.id))){return }var t,key=linb.event.currentKey,profile=linb.cache.dom[id];if(!profile){return }if(page.pProfile&&(page.pProfile!=profile.parent)){page.pProfile.selected=[]}if(t=profile.parent){if(key&&key[2]){t.reSelectObject.call(t,profile,profile.root.parent())}else{t.selectObject.call(t,profile,profile.root.parent())}}return false})},_enablePanelDesignFace:function(profile,key){profile.getSubNode(key,true).addClass("panel").addEventHandler("drop").addEventHandler("mousedown").addEventHandler("click").addEventHandler("drag").addEventHandler("dragstop").addEventHandler("mouseup")},_enablePanelDesign:function(profile){var t,key=profile.box.KEY,pool=linb.cache.$dropPool,page=this,h,k,self=this,cb={beforeMouseover:function(profile,e,src){var dd=linb.dragDrop,key=dd.dragKey,data=dd.data;if(!key||!data||!(new RegExp("\\b"+key+"\\b")).test(profile.box.getDropKeys(profile,this))||data.parentId==profile.$id||(data.data&&data.data.exists(profile.$id))||(profile.onDropTest&&(false===profile.boxing().onDropTest(profile,key,data)))){return }dd._current=src;_.resetRun("showDDMark",dd.showDDMark,0,[this],dd);var id=(id=profile.getItemByDom(src))&&id.id;if(profile.onDragEnter){profile.boxing().onDragEnter(profile,e,this,id)}},beforeDrop:function(profile,e,src){self._change();var target,dropx=linb.dragDrop.x,dropy=linb.dragDrop.y,dragKey=linb.dragDrop.dragKey,dragData=linb.dragDrop.dragData,type=dragData.type,iconPos=dragData.iconPos,data=dragData.data,pos=dragData.pos,ids,offset=self.dropOffset,fun=function(){var page=arguments.callee.page;if(!linb.SC(type).hasDomRoot){var o=linb.create(type,{$design:self.properties.$design}).get(0);page.iconlist.insertItems([{id:o.$id,icon:"img/widgets.gif",iconPos:iconPos}],null,false);page.iconlist.updateUIValue(o.$id)}else{if(self.dropPosition=="absolute"){var basePos=linb(src).absPos(),cssPos={left:parseInt((dropx-basePos.left)/offset)*offset,top:parseInt((dropy-basePos.top)/offset)*offset};target=new (linb.SC(linb.iBox.$type[type]))({$design:self.properties.$design});target.create();var p=target.get(0).properties;if(!p.$left){target.setLeft(["top","bottom","width","fill","cover"].exists(p.dock)?0:cssPos.left)}if(!p.$top){target.setTop(["left","right","height","fill","cover"].exists(p.dock)?0:cssPos.top)}if(!p.$position){target.setPosition("absolute")}target.setZIndex(1)}else{target=new (linb.SC(linb.iBox.$type[type]))({$design:self.properties.$design});target.create()}var pro=target.get(0);page._designable(pro);pro._host=page;var t=pro.box.$EventHandlers;for(var i in t){pro[i]=t[i]}ids=[target["linb.iBox"]?pro.$id:target.$id];if(target["linb.UI"]){profile.boxing().attach(target,profile.getItemIdByDom(src))}profile.setSelectFromPanel.call(profile,src,ids);src=null}};fun.page=page;if(type){if(linb.SC.evalPath(type)){fun()}else{linb.dom.UIAction(function(){linb.dom.setCover(linb.getRes("VisualJS.designer.loading")+type);linb.SC(type,true,fun)})}}else{var basePos=linb(src).absPos(),cssPos={left:parseInt((dropx-basePos.left)/offset)*offset,top:parseInt((dropy-basePos.top)/offset)*offset};var t;ids=data;target=linb.UI.getByCacheId(ids);var minx,miny;target.each(function(o,i){if(i===0){minx=o.properties.left;miny=o.properties.top}else{minx=Math.min(o.properties.left,minx);miny=Math.min(o.properties.top,miny)}});target.each(function(o){if(o.properties.dock!="none"){o.box.dock(o,true)}else{o.boxing().setLeft(o.properties.left-minx+cssPos.left).setTop(o.properties.top-miny+cssPos.top)}});profile.boxing().attach(target,profile.getItemIdByDom(src));profile.setSelectFromPanel.call(profile,src,ids)}},onMousedown:function(profile,e,src){if(linb.event.getSrc(e)!==src){return }var o=linb(src),pos=linb.event.getPos(e),absPos=o.absPos(),w=o.clientWidth(),h=o.clientHeight();if(pos.left-absPos.left>w){return }if(pos.top-absPos.top>h){return }profile._offsetPos=absPos;profile._scrollTop=o.scrollTop();profile._scrollLeft=o.scrollLeft();page._attachResizer(profile,src);profile._selregion={};var pos=linb.event.getPos(e);linb(src).startDrag(e,{move:false,type:"blank",cursor:"crosshair",target_left:pos.left,target_top:pos.top,defer:1});profile.$dragging=false},onClick:function(profile,e,src){if(linb.event.getSrc(e)!==src){return }self._clearSelect(profile);profile.setSelectFromPanel.call(profile,this,[])},beforeDrag:function(profile,e,src){var t,dd=linb.dragDrop,pos=dd.getOffset(),proxy=page.proxy;var region=profile._selregion;if((t=pos.x)<0){pos.x=-t}if((t=pos.y)<0){pos.y=-t}region.left=Math.min(dd.ox,dd.x)-profile._offsetPos.left+profile._scrollLeft;region.top=Math.min(dd.oy,dd.y)-profile._offsetPos.top+profile._scrollTop;region.width=pos.x;region.height=pos.y;proxy.setRegion(region);if(!profile.$dragging){proxy.display("block");profile.$dragging=true}},beforeDragstop:function(profile,e,src){var region=profile._selregion,proxy=page.proxy,selected=[],t,m,o,x1,y1,x2,y2,xx1,yy1,xx2,yy2,self=this;xx1=region.left;yy1=region.top;xx2=xx1+region.width;yy2=yy1+region.height;if(m=profile.children){m.each(function(v,i){v=v[0];if(v.domNode.parentNode===self){o=v.root;x1=o.offsetLeft();y1=o.offsetTop();x2=x1+o.width();y2=y1+o.height();if(xx2>x1&&x2>xx1&&yy2>y1&&y2>yy1){selected.push(v.$id)}}});profile.setSelectFromPanel.call(profile,this,selected)}_.asyRun(function(){proxy.display("none")})},onMouseup:function(profile,e,src){_.asyRun(function(){page.proxy.display("none")})}};var a=profile.properties.dropKeys.split(/[^\w]+/);a.filter(function(o){return !!o});if(a.indexOf("iDesign")==-1){a.push("iDesign")}profile.properties.dropKeys=a.join(":");if(t=pool[key]){var i=t[0];if(profile.keys.KEY==profile.keys[i]){h=cb}else{h={};h[i]=cb}profile._CB=h;profile.resetCache();page._enablePanelDesignFace(profile,i)}_.merge(profile,{selectObject:function(obj,node){var profile=this,id=obj.$id;return this.setSelectFromPanel(node,[id])},reSelectObject:function(obj,node){var profile=this;id=obj.$id;if(profile.selected&&profile.selected.exists(id)){profile.selected.removeValue(id)}else{(profile.selected||(profile.selected=[])).push(id)}return this.setSelectFromPanel(node,profile.selected)},setSelectFromResizer:function(ids){var profile=this;profile.selected=ids;return this.resetSelectRel()},setSelectFromPanel:function(node,ids){var profile=this;if(self.pProfile!==profile||self.pNode!==node){self._clearSelect(profile);self._attachResizer(profile,node)}profile.selected=ids;self.resizer.resetTarget(linb.UI.getByCacheId(profile.selected).reBoxing(),false);return this.resetSelectRel()},resetSelectRel:function(){var profile=this;if(profile.selected&&profile.selected.length){var t=self.resizer.get(0).properties;t.dragArgs={key:"iDesign",grid_width:self.dropOffset,grid_height:self.dropOffset,data:{parentId:profile.$id,data:profile.selected}}}else{self._clearSelect(profile)}_.tryF(self._WidgetsSelected,[profile.selected],self);self._focus()}},"all")},_refreshProfileGrid:function(ids){var page=this;this.profileGrid.resetContent();if(!ids||!ids.length){var pro=this.canvas.get(0);var arr=[];var eh=_.get(this.properties.clsObject,["Static","EventHandlers"]);if(!eh){eh=linb.Com.EventHandlers}var em=_.get(this.properties.clsObject,["Instance","events"]);var getCode=function(o){var code;var em=_.get(o.clsStruct,["sub","Instance","sub","events","code"]);if(em){em=_.unserialize(em)}else{em={}}var funName=em[o.funName]||("_"+o.funName.toLowerCase());var item=_.get(o.clsStruct,["sub","Instance","sub",funName]);var comments=(item?(item.comments||""):"");if(comments){comments=comments.replace(/^[\r\n]*/,"")}if(item&&item.code){code=item&&item.code;o.mapName=em[o.funName]}else{if(!o.ini){return""}code=" ".repeat(8)+o.ini.toString().replace(/\n/g,"\n"+" ".repeat(8));o.mapName="_"+o.funName.toLowerCase();var pool=_.get(o.clsStruct,["sub","Instance","sub"]);if(pool[o.mapName]){var i=1,t;while(pool[t=o.mapName+"_"+(++i)]){}o.mapName=t}}return comments+code};_.each(eh,function(o,i){var $fun=function(profile,cell){var o=cell.$tagVar;var node=profile.getSubNode("CELL",cell._serialId);linb.ComFactory.newCom("VisualJS.ObjectEditor",function(){this.host=page;this.setProperties({icon:"img/App.gif",iconPos:"-32px -32px",text:getCode(o),caption:o.widgetName+" => "+o.funName,fromRegion:node.getRegion(true),tagVar:o,onOK:function(page){this._change();var tagVar=page.properties.tagVar;if(page.properties.result.code!==null){_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"code"],page.properties.result.code);_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"comments"],page.properties.result.comments);profile.box.changeCellValue(profile,cell,tagVar.mapName,true)}else{_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"code"],null);_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"comments"],null);var em=_.get(tagVar.clsStruct,["sub","Instance","sub","events","code"]);if(em){em=_.unserialize(em);delete em[tagVar.funName];_.set(tagVar.clsStruct,["sub","Instance","sub","events","code"],_.serialize(em))}profile.box.changeCellValue(profile,cell,"",true)}node.focus()}});this.show(linb([document.body]))})},$tagVar={widgetName:"page",obj:this.properties.clsObject,clsStruct:this.properties.clsStruct,clsObject:this.properties.clsObject,funName:i,mapName:(em&&em[i])||"",ini:o};arr.push({id:"event:"+i,cells:[{value:i,type:null,$tagVar:null,event:null},{value:(em&&em[i])||"",type:"popbox",$tagVar:$tagVar,event:$fun}]})},this);var rows=[{id:"alias",cells:[{value:"alias",type:"label"},{value:"page",type:"label"}]},{id:"properties:width",cells:[{value:"width",type:"label"},{value:pro.properties.width,type:""}]},{id:"properties:height",cells:[{value:"height",type:"label"},{value:pro.properties.height,type:""}]},{id:"UIE",cells:[{value:"events",type:"label"},{value:"",type:"label"}],sub:arr}];var list=[];this.profileGrid.insertRows(rows);this.profileGrid.get(0).$widget=this.canvas}else{var t,len,uis=linb.UI.getByCacheId(ids);if(len=uis.length()){var pro=uis.get(this.SelectedFocus);var cache=[0,0,0,0,0,0,0,0],cache2=0;var $fun=function(profile,cell){var o=cell.$tagVar;var node=profile.getSubNode("CELL",cell._serialId);var obj=o.profile[o.name];linb.ComFactory.newCom("VisualJS.ObjectEditor",function(){this.host=page;this.setProperties({caption:o.widgetName+" => "+o.name,icon:"img/App.gif",iconPos:obj.constructor==Array?"-128px -32px":"-16px -32px",text:linb.coder.decode(_.serialize(linb.UI.pickObj(obj))),fromRegion:node.getRegion(true),tagVar:o,onOK:function(page){this._change();var tagVar=page.properties.tagVar;tagVar.profile.boxing()[tagVar.funName](page.properties.object);node.focus()}});this.show(linb([document.body]))})};var rows=[{id:"key",cells:[{value:"class",type:"label"},{value:"<strong>"+pro.key+"</strong>",type:"label"}]},{id:"alias",cells:[{value:"alias",type:"label"},{value:pro.alias,type:""}]},{id:"template",cells:[{value:"template",type:""},{value:pro.template._id,type:"listbox",listKey:pro.box.KEY+":template"}]},{id:"appearance",cells:[{value:"appearance",type:""},{value:pro.appearance,type:"listbox",listKey:pro.box.KEY+":appearance"}]},{id:"behavior",cells:[{value:"behavior",type:""},{value:pro.behavior._id,type:"listbox",listKey:pro.box.KEY+":behavior"}]},{id:"properties",cells:[{value:"properties",type:"label"},{value:"",type:"label"}],sub:[]},{id:"UIE",cells:[{value:"events",type:"label"},{value:"",type:"label"}],sub:[]},{id:"CA",cells:[{value:"Custom Appearances",type:"label"},{value:"(Collection)",event:$fun,$tagVar:{name:"CA",funName:"setCustomAppearance",profile:pro},type:"popbox:readonly"}]},{id:"CC",cells:[{value:"Custom Class",type:"label"},{value:"(Collection)",event:$fun,$tagVar:{name:"CC",funName:"setCustomClass",profile:pro},type:"popbox:readonly"}]},{id:"CB",cells:[{value:"Custom Behaviors",type:"label"},{value:"(Collection)",event:$fun,$tagVar:{name:"CB",funName:"setCustomBehavior",profile:pro},type:"popbox:readonly"}]},{id:"CF",cells:[{value:"Custom Functions",type:"label"},{value:"(Collection)",event:$fun,$tagVar:{name:"CF",funName:"setCustomFunction",profile:pro},type:"popbox:readonly"}]}];var arr=[],map=CONF.mapWidgets[pro.box.KEY];t=map&&map.Templates;if(!t){t=[]}if(!t.exists("default")){t.insertAny("default",0)}t.each(function(o){arr.push({id:o,caption:o,value:o})});linb.UI.setCacheList(pro.box.KEY+":template",arr);arr=[];t=map&&map.Appearances;if(!t){t=[]}if(!t.exists("default")){t.insertAny("default",0)}t.each(function(o){arr.push({id:o,caption:o,value:o})});linb.UI.setCacheList(pro.box.KEY+":appearance",arr);arr=[];t=map&&map.Behaviors;if(!t){t=[]}if(!t.exists("default")){t.insertAny("default",0)}t.each(function(o){arr.push({id:o,caption:o,value:o})});linb.UI.setCacheList(pro.box.KEY+":behavior",arr);arr=[];uis.each(function(t,i){if(i===len-1){return }if(!cache[0]&&t.key!=pro.key){cache[0]=1;cache2++}if(!cache[1]){rows[1].cells[1].type="label";cache[1]=1;cache2++}if(!cache[2]&&t.template._id!=pro.template._id){rows[2].cells[1].type="label";cache[2]=1;cache2++}if(!cache[3]&&t.appearance!=pro.appearance){rows[3].cells[1].type="label";cache[3]=1;cache2++}if(!cache[4]&&t.behavior._id!=pro.behavior._id){rows[4].cells[1].type="label";cache[4]=1;cache2++}if(!cache[5]){rows[5].cells[1].type="label";cache[5]=1;cache2++}if(cache2==6){return false}});this.profileGrid.insertRows(rows);this.profileGrid.get(0).$widget=uis}else{uis=linb.Base.getByCacheId(ids[0]);pro=uis.profile;var rows=[{id:"key",cells:[{value:"class",type:"label"},{value:pro.key,type:"label"}]},{id:"alias",cells:[{value:"alias",type:"label"},{value:pro.alias,type:""}]},{id:"properties",cells:[{value:"properties",type:"label"},{value:"",type:"label"}],sub:[]},{id:"UIE",cells:[{value:"events",type:"label"},{value:"",type:"label"}],sub:[]}];this.profileGrid.insertRows(rows);this.profileGrid.get(0).$widget=uis}}},_change:function(){this._dirty=true;_.tryF(this.events.onValueChanged,[this,null,this._dirty],this.host)},$toolbar_onclick:function(profile,id,groupid,src){var page=this;switch(groupid){case"code":switch(id){case"format":case"json":linb.dom.UIAction(function(){var dialog=new linb.UI.Dialog();dialog.setLeft(100).setTop(100).setWidth(300).setHeight(200).setStatus("max").setMinBtn(false).setMaxBtn(false).setCaption("Formatted code");dialog.create();var t,nodes;if(page.tempSelected&&page.tempSelected.length){nodes=[];page.tempSelected.each(function(i){nodes.push(linb.Profile.getFromCacheId(i))})}else{nodes=page.getWidgets()}var code;switch(id){case"format":code=linb.coder.parse(page.getJSCode(nodes),"js",["plain"]);break;case"json":code=linb.coder.format(page.getJSONCode(nodes),"js",["plain"]);break}dialog.html(code);dialog.show(linb(document.body),true)});break}break;case"align":this._change();var sel=linb.UI.getByCacheId(this.tempSelected);var p=sel.get(this.SelectedFocus),o=p.getSubNode("KEY"),size=o.cssSize(),pos=o.cssPos();sel.each(function(o){if(o.locked){return }var node=o.getSubNode("KEY");switch(id){case"left":node.left(pos.left);o.boxing().refreshLeft();break;case"center":node.left(pos.left+size.width/2-node.width()/2);o.boxing().refreshLeft();break;case"right":node.left(pos.left+size.width-node.width());o.boxing().refreshLeft();break;case"top":node.top(pos.top);o.boxing().refreshTop();break;case"middle":node.top(pos.top+size.height/2-node.height()/2);o.boxing().refreshTop();break;case"bottom":node.top(pos.top+size.height-node.height());o.boxing().refreshTop();break;case"w":node.width(size.width);o.boxing().refreshWidth();break;case"wh":node.width(size.width).height(size.height);o.boxing().refreshWidth();o.boxing().refreshHeight();break;case"h":node.height(size.height);o.boxing().refreshHeight();break}});this.resizer.rePosSize();this._focus();break;case"pos":this._change();var sel=linb.UI.getByCacheId(this.tempSelected);var page=this;if("clone"==id){var ids=[];var t,ids=[],pid;var src=linb.UI.getByCacheId(this.tempSelected);var tar=src.clone();src.get(0).parent.boxing().attach(tar);pid=src.get(0).parent.$id;tar.each(function(o){ids.push(o.$id)});tar.each(function(o){page._designable(o)});this.resizer.resetTarget(linb(tar));linb.message(linb.getRes("VisualJS.designer.colneOK",ids.length));return }var zIndex=0;sel.each(function(o){var ins=o.boxing();var node=ins.reBoxing();switch(id){case"zindex1":if(o.locked){return }if(!zIndex){zIndex=node.topZindex()}node.zIndex(zIndex+1);ins.refreshZIndex();break;case"zindex2":if(o.locked){return }node.zIndex(0);ins.refreshZIndex();break;case"repos":case"resize":if(o.locked){return }var l=node.left(),t=node.top(),offset=page.dropOffset;node.left(parseInt(l/offset)*offset).top(parseInt(t/offset)*offset);if(id=="resize"){var w=node.width(),h=node.height();node.width((parseInt((w+offset-1)/offset))*offset).height((parseInt((h+offset-1)/offset))*offset)}page.resizer.rePosSize();ins.refreshLeft();ins.refreshTop();ins.refreshWidth();ins.refreshHeight();break}});this._focus();break;case"del":this._change();if("delete"==id){this._deleteSelected()}break}},$profilegrid_afterrowactive:function(profile,row){profile.box.editCellbyRowCol(profile,row.id,"value");return false},$profilegrid_beforevalueupdated:function(profile,cell,ov,nv){this._change();var page=this;try{var attr,t,type,funName,property,value,target=profile.$widget;value=nv;if((attr=cell._row.id.split(":")).length>1){type=attr[0];property=attr[1]}else{property=cell._row.id}switch(type){case"properties":funName="set"+property.initial();if(target.get(0)==this.canvas.get(0)){this.canvas[funName](value);this.panelBG[funName](value)}else{target.each(function(o){o.boxing()[funName](value)});if(["left","top","width","height","right","bottom","dock","dockOrder"].exists(property)){this.resizer.rePosSize()}}break;case"event":if(target.get(0)==this.canvas.get(0)){if(nv){var em=_.get(page.properties.clsStruct,["sub","Instance","sub","events","code"]);if(em){em=_.unserialize(em)}else{em={}}em[property]=nv;_.set(page.properties.clsStruct,["sub","Instance","sub","events","code"],_.serialize(em));_.set(page.properties.clsStruct,["sub","Instance","sub","events","comments"],_.get(page.properties.clsStruct,["sub","Instance","sub","events","comments"]||"\n"+" ".repeat(8)));_.set(page.properties.clsObject,["Instance","events",property],nv)}}else{target.each(function(o){if(nv){o[property]=nv;_.set(page.properties.clsObject,["Instance",property],nv)}else{delete o[property]}})}break;default:if(property=="alias"){var hash=this.getNames();if(hash[value]){linb.message(linb.getRes("VisualJS.designer.nameExists",value));return false}this.listObject.setCtrlValue(value,true)}target[property](value)}}catch(e){throw (e);return false}},$profilegrid_onrequestdata:function(profile,item,threadId){var cv,arr=[],t,page=this,id=item.id,deeppage=this,uis=profile.$widget,len=uis.length();var target=uis.get(len-1),dm=target.box.$DataModel,format,listKey,list,$tag,$fun,$tagVar,value;if(id=="properties"){_.each(target.box.$DataStruct,function(o,i){if(["_","$"].exists(i.charAt(0))){return }if(dm[i].hidden){return }list=null;$tag="";cv="";if(dm[i].readonly){listKey="";type="label"}else{if(dm[i].listbox){type="listbox";list=[];listKey=target.key+":properties:"+i;if(_.isFun(dm[i].listbox)){var d=dm[i].listbox;list=function(){var a=d.call(target),list=[];a.each(function(o){list.push({id:o,caption:o,value:o})});return list}}else{if(_.isObj(dm[i].listbox[0])){list=dm[i].listbox.copy()}else{dm[i].listbox.each(function(o,i){list.push({id:o,caption:o})})}}linb.UI.setCacheList(listKey,list)}else{if(dm[i].combobox){type="combobox";list=[];if(_.isFun(dm[i].combobox)){var d=dm[i].combobox;list=function(){var a=d.call(target),list=[];a.each(function(o){list.push({id:o,caption:o})});return list}}else{if(_.isObj(dm[i].combobox[0])){list=dm[i].combobox.copy()}else{dm[i].combobox.each(function(o,i){list.push({id:o,caption:o})})}}listKey=target.key+":properties:"+i;linb.UI.setCacheList(listKey,list)}else{if(dm[i].helpinput){listKey=target.key+":properties:"+i;type="helpinput";list=dm[i].helpinput.copy();linb.UI.setCacheList(listKey,list)}else{if(dm[i].trigger){listKey="";type="getter";value=i;$fun=function(profile,cell,pro){var o=cell.$tagVar;var f=o.profile.boxing()["trigger"+o.name.initial()];_.tryF(f,null,o.profile.boxing());var v="try again";pro.boxing().updateUIValue(v);profile.box.changeCellValue(profile,cell,v,true)};$tagVar={profile:target,name:i}}else{if(_.isBool(o)){listKey="";type="checkbox";$tag=i}else{if(_.isObj(o)){listKey="";type="popbox:readonly";$tag=null;$fun=function(profile,cell){var o=cell.$tagVar;var node=profile.getSubNode("CELL",cell._serialId);var obj=o.profile.boxing()["get"+o.name.initial()]();linb.ComFactory.newCom("VisualJS.ObjectEditor",function(){this.host=page;this.setProperties({caption:o.widgetName+" => "+o.name,icon:"img/App.gif",iconPos:obj.constructor==Array?"-128px -32px":"-16px -32px",text:linb.coder.decode(_.serialize(linb.UI.pickObj(obj))),fromRegion:node.getRegion(true),tagVar:o,onOK:function(page){this._change();var t,tagVar=page.properties.tagVar;tagVar.profile.boxing()["set"+o.name.initial()](page.properties.object);if(["dockMargin"].exists(o.name)){deeppage.resizer.rePosSize()}node.focus();if(o.name=="items"){if(null===page.properties.object){tagVar.profile.boxing().setItems([])}if(t=linb.cache.$dropPool[tagVar.profile.box.KEY]){var i=t[0];deeppage._enablePanelDesignFace(tagVar.profile,i)}}}});this.show(linb([document.body]))})};$tagVar={widgetName:target.alias,profile:target,name:i};cv="(Collection)"}else{listKey="";type=""}}}}}}}cv=cv||target.properties[i];if(_.isStr(cv)){}arr.push({id:"properties:"+i,cells:[{value:i,type:"",$tag:"",event:"",$tagVar:"",listKey:""},{value:cv,type:type,$tag:$tag,event:$fun,$tagVar:$tagVar,listKey:listKey}]})})}arr.sort(function(x,y){x=x.cells[0].value;y=y.cells[0].value;return x>y?1:x==y?0:-1});if(id=="UIE"){var getCode=function(o){var code;var funName=typeof o.profile[o.funName]=="string"?o.profile[o.funName]:("_"+o.widgetName.toLowerCase()+"_"+o.funName.toLowerCase());var item=_.get(o.clsStruct,["sub","Instance","sub",funName]);var comments=(item?(item.comments||""):"");if(comments){comments=comments.replace(/^[\r\n]*/,"")}if(item&&item.code){code=item&&item.code;o.mapName=funName}else{code=" ".repeat(8)+o.ini.toString().replace(/\n/g,"\n"+" ".repeat(8));o.mapName="_"+o.widgetName.toLowerCase()+"_"+o.funName.toLowerCase();var pool=_.get(o.clsStruct,["sub","Instance","sub"]);if(pool[o.mapName]){var i=1,t;while(pool[t=o.mapName+"_"+(++i)]){}o.mapName=t}}return comments+code};$fun=function(profile,cell){var o=cell.$tagVar;var node=profile.getSubNode("CELL",cell._serialId);linb.ComFactory.newCom("VisualJS.ObjectEditor",function(){this.host=page;this.setProperties({icon:"img/App.gif",iconPos:"-32px -32px",caption:o.widgetName+" => "+o.funName,text:getCode(o),fromRegion:node.getRegion(true),tagVar:o,onOK:function(page){this._change();var tagVar=page.properties.tagVar;if(page.properties.result.code!==null){_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"code"],page.properties.result.code);_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"comments"],page.properties.result.comments);tagVar.profile[tagVar.funName]=tagVar.mapName;profile.box.changeCellValue(profile,cell,tagVar.mapName,true)}else{_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"code"],null);_.set(tagVar.clsStruct,["sub","Instance","sub",tagVar.mapName,"comments"],null);tagVar.profile[tagVar.funName]=tagVar.profile.box.$EventHandlers[tagVar.funName];profile.box.changeCellValue(profile,cell,"",true)}node.focus()}});this.show(linb([document.body]))})};_.each(target.box.$EventHandlers,function(o,i){$tagVar={profile:target,clsStruct:page.properties.clsStruct,widgetName:target.alias,funName:i,ini:o};arr.push({id:"event:"+i,cells:[{value:i,type:null,$tagVar:null},{value:typeof target[i]=="string"?target[i]:"",type:"popbox",$tagVar:$tagVar,event:$fun}]})})}uis.each(function(tt,i){if(i===(len-1)){return }if(id=="properties"){var cache=[],cache2=0;arr.each(function(o,i){if(cache2==arr.length){return false}if(!cache[i]&&tt.properties[o.cells[0].value]!==target.properties[o.cells[0].value]){o.cells[1].type="label";cache[i]=1;cache2++}})}if(id=="UIE"){arr.length=0}});linb.thread(threadId).setCache("response",arr)},$iconlist_aftervalueupdated:function(profile,ov,nv){if(nv){this.resizer.resetTarget(null,false);this._setSelected([nv],true)}},$listobject_onlistshow:function(profile,pos){var page=this;if(!page.objlistBlock){page.objlistBlock=new linb.UI.Block({width:200,height:200,shadow:true});page.frame=linb.create('<div style="z-index:2000;background-color:red;position:absolute;font-size:0;line-height:0;display:none;">').opacity(0.3);linb(document.body).addLast(page.frame);page.treebarObj=new linb.UI.TreeBar({group:false,selMode:"none",caption:null},{onItemSelected:function(profile,item,src){page.selectWidget(item.id);profile.parent.root.display("none");page.frame.display("none");profile.boxing().clearItems();_.asyRun(function(){page._focus()})},beforeHoverEffect:function(profile,item,src,type){if(!item){return }if(item.id==this.canvas.get(0).$id){return }if(type=="mouseover"){_.resetRun("",function(){var v=linb._object[item.id];if(v&&(v=v.root)){page.frame.setRegion(v.getRegion(true)).display("block")}},100)}else{_.resetRun("",function(){page.frame.display("none")},100)}}},page);page.objlistBlock.attach(page.treebarObj).create()}var items=[];var fun=function(profile,items,map){var self=arguments.callee,t,item={id:profile.$id,caption:profile.alias,icon:(t=map[profile.box.KEY])?t.icon:"",iconPos:(t=map[profile.box.KEY])?t.iconPos:""};items.push(item);if(profile.children&&profile.children.length){var sub=[];item.sub=sub;profile.children.each(function(o){self.call(null,o[0],sub,map)})}};fun(page.canvas.get(0),items,CONF.mapWidgets);page.treebarObj.setItems(items).toggleNode(page.canvas.get(0).$id,true);var node=page.objlistBlock.reBoxing();node.popToTop(profile.root);var unFun=function(){node.display("none");page.treebarObj.clearItems();page.frame.display("none");linb.event.hookKey("esc",0,0,0,null)};node.setBlurTrigger("design:pop:objecttree",unFun);linb.event.hookKey("esc",0,0,0,unFun)},getWidgets:function(flag){if(!flag){this._clearSelect(this.canvas.get(0))}var arr=[],c=this.canvas.get(0).children;c.each(function(o){arr.push(o[0])});var items=this.iconlist.getItems();if(items&&items.length){items.each(function(o,i){arr.push(linb.Profile.getFromCacheId(o.id))})}arr.clean();return arr},getJSONCode:function(nodes){nodes.sort(function(x,y){x=parseInt(x.properties.tabindex)||0;y=parseInt(y.properties.tabindex)||0;return x>y?1:x==y?0:-1});return"return this._nodes = linb.create("+_.serialize(nodes)+").get();"},getJSCode:function(nodes){nodes.sort(function(x,y){x=parseInt(x.properties.tabindex)||0;y=parseInt(y.properties.tabindex)||0;return x>y?1:x==y?0:-1});var page=this,t,arr=[];arr.push("// [[code created by designer, don't change it manually\n");arr.push("var t=this, n=t._nodes=[], u=linb.UI, f=function(c){n.push(c.get(0))};");fun=function(v,pName,argsStr,arr){var self=arguments.callee,ui=v.box["linb.UI"],o=v.beforeSerialized(),name=o.alias,b;delete o.id;if(o.properties&&o.properties.dropKeys){o.properties.dropKeys=o.properties.dropKeys.replace(/\biDesign\b/,"").replace(/[^\w]+/g,":").replace(/^[^\w]+/,"").replace(/[^\w]+$/,"");if(o.properties.dropKeys==v.box.$DataStruct.dropKeys){delete o.properties.dropKeys}}if(_.isEmpty(o.properties)){delete o.properties}if(_.isEmpty(o.events)){delete o.events}if(_.isEmpty(o.CA)){delete o.CA}if(_.isEmpty(o.CC)){delete o.CC}if(_.isEmpty(o.CB)){delete o.CB}if(_.isEmpty(o.CF)){delete o.CF}arr.push("\n\n");if(pName){arr.push(pName+".attach(")}else{arr.push("f(")}arr.push("\n(new "+o.key.replace("linb.UI","u")+")");arr.push('\n.host(t,"'+name+'")');if(o.template){arr.push('\n.template("'+o.template+'")')}if(o.behavior){arr.push('\n.behavior("'+o.behavior+'")')}if(o.appearance){arr.push('\n.appearance("'+o.appearance+'")')}if(o.properties){_.each(o.properties,function(o,i){arr.push("\n.set"+i.initial()+"("+_.serialize(o)+")")})}if(o.events){_.each(o.events,function(o,i){arr.push("\n."+i+"("+_.serialize(o)+")")})}if(o.CA){arr.push("\n.setCustomAppearance("+_.serialize(o.CA)+")")}if(o.CC){arr.push("\n.setCustomClass("+_.serialize(o.CC)+")")}if(o.CB){arr.push("\n.setCustomBehavior("+_.serialize(o.CB)+")")}if(o.CF){arr.push("\n.setCustomFunction("+_.serialize(o.CF)+")")}if(pName){arr.push("\n"+(argsStr?(", "+argsStr):"")+");")}else{arr.push("\n);")}if(v.children&&v.children.length){v.children.each(function(o){var j=o[0],sa=[],s;for(var i=1;i<o.length;i++){switch(typeof o[i]){case"number":sa.push(o[i]);break;case"string":sa.push("'"+o[i]+"'");break}}if(sa.length){s=sa.join(",")}else{s=null}self.call(this,j,"t."+name,s,arr)},this)}};nodes.each(function(v){fun(v,null,null,arr)});arr.push("\n\n");arr.push("return n;\n");arr.push("// ]]code created by designer");return arr.join("")},getClassList:function(nodes){var page=this,t,hash={};var fun=function(target){var self=arguments.callee;hash[target.box.KEY]=1;if(target.children&&target.children.length){target.children.each(function(o){self.call(null,o[0])})}};nodes.each(function(o){fun(o)});return _.toArr(hash,true)},getNames:function(){var nodes=this.getWidgets(true);var page=this,t,hash={};var fun=function(target){var self=arguments.callee;hash[target.alias]=1;if(target.children&&target.children.length){target.children.each(function(o){self.call(null,o[0])})}};nodes.each(function(o){fun(o)});return hash},selectWidget:function(id){var profile=linb.UIProfile.getFromCacheId(id);var p=profile.parent;if(p.setSelectFromPanel){p.setSelectFromPanel.call(p,profile.root.parent(),id);this._setSelected([id],true)}else{this._clearSelect();this._setSelected(null,true)}},activate:function(){},resetEnv:function(text){this._dirty=false;this.properties.text=text||this.getText();this._clearSelect();this._setSelected([],true)},setText:function(txt,flag,threadid){txt=txt.replace(/\r\n/g,"\n");if(flag||this.properties.text!=txt){this.properties.text=txt;var clsStruct=this.properties.clsStruct;var clsObject=this.properties.clsObject;var comCode=_.get(clsStruct,["sub","Instance","sub","iniComponents","code"]);if(comCode==this.properties.comCode){return this}var page=this;linb.thread.asyUI(threadid,[function(){linb.dom.setCover(linb.getRes("VisualJS.designer.emptyContent"))},function(){page.canvas.reBoxing().empty().gc();linb.dom.setCover(linb.getRes("VisualJS.designer.prepare"))},function(threadid){linb.thread.suspend(threadid);linb.SC.group(clsObject.Instance.required,function(key){linb.dom.setCover(linb.getRes("VisualJS.designer.loading")+" "+key+"...")},function(){linb.dom.setCover(linb.getRes("VisualJS.designer.createContent"));linb.thread.resume(threadid)})},function(){try{var nodes=clsObject.Instance.iniComponents.call(null);page.iconlist.clearItems();var n2=[];nodes.filter(function(target){if(!target.box.hasDomRoot){n2.push(target);return false}});page.canvas.attach(linb.UI.pack(nodes,false));nodes.each(function(o){page._designable(o)});n2.each(function(target){target.properties.$design=page.properties.$design;page.iconlist.insertItems([{id:target.$id,icon:"img/widgets.gif",iconPos:CONF.mapWidgets[target.box.KEY].iconPos}],null,false)});if(page.layoutBase.reBoxing().display()=="none"){page.layoutBase.reBoxing().display("block");page.layoutBase.reBoxing().parent().background("")}}catch(e){page.iconlist.clearItems();page.canvas.reBoxing().empty().gc();page.layoutBase.reBoxing().display("none");page.layoutBase.reBoxing().parent().background("url(img/error.gif)");linb.message(linb.getRes("VisualJS.designer.comCodeErr"));linb.message(_.Error(e))}}])}this.resetEnv(txt);return this},getText:function(){if(this._dirty){var nodes=this.getWidgets(),ins=this.properties.clsStruct.sub.Instance;if(!nodes.length){if(_.get(ins,["sub","iniComponents","comments"])){_.set(ins,["sub","iniComponents","comments"],null)}}else{if(!_.get(ins,["sub","iniComponents","comments"])){_.set(ins,["sub","iniComponents","comments"],"\n"+" ".repeat(8))}ins.sub.iniComponents.code=("function(){\n"+this.getJSCode(nodes)).replace(/\n/g,"\n"+" ".repeat(12))+"\n"+" ".repeat(8)+"}"}var arr=this.properties.clsObject.Instance.required||[];arr.merge(this.getClassList(nodes));_.set(ins,["sub","required","code"],_.serialize(arr));if(!_.get(ins,["sub","required","comments"])){_.set(ins,["sub","required","comments"],"\n"+" ".repeat(8))}return VisualJS.ClassTool.getCodeFromStruct(this.properties.clsStruct)}return this.properties.text},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Layout).host(t,"layoutBase").setLeft(0).setTop(0).setItems([{id:"main",min:10},{id:"after",pos:"after",locked:false,cmd:false,size:270,min:100,max:300,hide:false}]).setType("horizontal"));t.layoutBase.attach((new u.IconList).host(t,"iconlist").setDock("bottom").setHeight(20).setItemWidth(16).setItemHeight(16).setItemPadding(1).setZIndex(10).setItems([]).setCustomAppearance({KEY:"background:#FFFACD",ITEMS:"padding:2px"}).afterValueUpdated("$iconlist_aftervalueupdated"),"main");t.layoutBase.attach((new u.ToolBar).host(t,"toolbar").onClick("$toolbar_onclick"),"main");t.layoutBase.attach((new u.Layout).host(t,"layoutLeft").setLeft(0).setTop(0).setItems([{id:"main",min:10},{id:"after",pos:"after",locked:false,size:300,min:100,max:500,cmd:true,hide:false}]),"after");t.layoutLeft.attach((new u.ComboInput).host(t,"listObject").setDock("top").setType("popbox").setReadonly(true).setItems([]).onClickButton("$listobject_onlistshow"),"after");t.layoutLeft.attach((new u.TreeGrid).host(t,"profileGrid").setHeader([{id:"name",caption:"$VisualJS.designer.gridcol1",width:80,type:"label"},{id:"value",caption:"$VisualJS.designer.gridcol2",width:130,type:"input"}]).setRows([]).setRowHandlerWidth(30).setAltRowsBg(false).setRowDragable(false).setColSortable(false).beforeValueUpdated("$profilegrid_beforevalueupdated").onRequestData("$profilegrid_onrequestdata").afterRowActive("$profilegrid_afterrowactive"),"after");t.layoutLeft.attach((new u.TreeBar).host(t,"treebarCom").setLeft(0).setTop(0).setItems([]).setGroup(true).setSelMode("none").setDragKey("iDesign"),"main");t.layoutBase.attach((new u.Div).host(t,"panelDiv").setDock("fill").afterCreated(function(pro){pro.root.addClass("linbdesign")}).setCustomAppearance({KEY:"overflow:auto;"}),"main");t.panelDiv.attach((new u.Div).host(t,"panelBG").setTop(5).setLeft(5).setCustomAppearance({KEY:"background-color:#FFFEF6;"}));t.panelBG.attach((new u.Div).host(t,"panelBGl").setCustomAppearance({KEY:"font-size:0;line-height:0;position:absolute;left:0;top:0;width:10px;height:100%;background:url(img/designer/left.gif) left top"}));t.panelBG.attach((new u.Div).host(t,"panelBGb").setCustomAppearance({KEY:"font-size:0;line-height:0;position:absolute;left:0;bottom:0;height:10px;width:100%;background:url(img/designer/top.gif) left bottom"}));t.panelBG.attach((new u.Div).host(t,"panelBGt").setCustomAppearance({KEY:"font-size:0;line-height:0;position:absolute;left:0;top:0;height:10px;width:100%;background:url(img/designer/top.gif) left top"}));t.panelBG.attach((new u.Div).host(t,"panelBGr").setCustomAppearance({KEY:"font-size:0;line-height:0;position:absolute;right:0;top:0;width:10px;height:100%;background:url(img/designer/left.gif) top right"}));t.panelDiv.attach((new u.Panel).host(t,"canvas").setTop(5).setLeft(5).setZIndex(10).setCustomAppearance({KEY:"overflow:hidden"}));return n}},Static:{destroy:function(){this.objlistBlock.destroy();arguments.callee.upper.apply(this,arguments)}},Initialize:function(){linb.css.add(linb.UI.buildCSSText({".linbdesign .panel":{"background-image":"url(img/designer/bg.gif)","background-position":"left top"}}),"linb.UI.design")}});Class("VisualJS.AddFile","linb.Com",{Instance:{customAttach:function(parent){var self=this,dlg=self.dialog,prop=self.properties;if(prop.fromRegion){dlg.setFromRegion(prop.fromRegion)}dlg.setCaption(prop.caption).setIcon(prop.icon).setIconPos(prop.iconPos);if(!dlg.get(0).root){dlg.create()}self.treebar.resetValue();self.input.resetValue();self.inputTarget.resetValue();self.comboinput.setValue(".js",true);dlg.show(parent,true);var arr=linb.UI.pickObj(prop.items||[]),f=function(o){var self=arguments.callee;o.filter(function(o,i){var k=o.sub;if(k){self(o.sub)}if(k&&!k.length){delete o.sub}return !!k})};f(arr);self.treebar.clearItems().insertItems(arr)},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Dialog).host(t,"dialog").setLeft(240).setTop(80).setWidth(430).setHeight(270).setResizable(false).setMinBtn(false).setMaxBtn(false).setPinBtn(false).setCaption("dialog").onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));t.dialog.attach((new u.Button).host(t,"btnCancel").setLeft(80).setTop(210).setWidth(90).setCaption("$VisualJS.cancel").setIcon("img/App.gif").setIconPos("-16px -16px").onClick("_btncancel_onclick"));t.dialog.attach((new u.Label).host(t,"label4").setLeft(10).setTop(180).setWidth(70).setCaption("$VisualJS.addfile.target"));t.dialog.attach((new u.ComboInput).host(t,"comboinput").setValue(".js").setLeft(300).setTop(150).setWidth(110).setReadonly(true).setType("listbox").setItems([{id:"/",caption:"$VisualJS.addfile.iDir"},{id:".html",caption:"$VisualJS.addfile.iHtml"},{id:".js",caption:"$VisualJS.addfile.iJs"},{id:".php",caption:"$VisualJS.addfile.iPhp"}]).afterValueUpdated("_refresh"));t.dialog.attach((new u.PanelBar).host(t,"panelbar2").setDock("top").setHeight(140).setZIndex(1).setCaption("$VisualJS.addfile.sel"));t.panelbar2.attach((new u.TreeBar).host(t,"treebar").setDock("none").setPosition("relative").setItems([]).setIniFold(false).onItemSelected("_refresh"));t.dialog.attach((new u.Label).host(t,"label1").setLeft(10).setTop(150).setWidth(70).setCaption("$VisualJS.addfile.filename"));t.dialog.attach((new u.Button).host(t,"btnOK").setLeft(250).setTop(210).setWidth(90).setCaption("$VisualJS.ok").setIcon("img/App.gif").setIconPos("-64px -16px").onClick("_btnok_onclick"));t.dialog.attach((new u.Label).host(t,"label3").setLeft(230).setTop(150).setWidth(70).setCaption("$VisualJS.addfile.filetype"));t.dialog.attach((new u.Input).host(t,"input").setLeft(80).setTop(150).setWidth(140).setValueFormat("^[\\w_]{2,18}$").setTipsErr("$VisualJS.addfile.filenameformat").afterValueUpdated("_refresh"));t.dialog.attach((new u.Input).host(t,"inputTarget").setLeft(80).setTop(180).setWidth(330).setReadonly(true));return n},_dialog_beforeclose:function(profile){this.dialog.hide();return false},_btncancel_onclick:function(profile,e,value){this.dialog.close()},_refresh:function(){var self=this,s1=self.treebar.getUIValue(),s2=self.input.getUIValue(),s3=self.comboinput.getUIValue();if(s1&&s2&&s3){self.inputTarget.setValue(s1+"/"+s2+s3,true)}},_btnok_onclick:function(profile,e,value){var self=this,s=self.inputTarget.getValue();if(!s){linb.message(linb.getRes("VisualJS.addfile.notarget"))}else{_.tryF(self.properties.onOK,[self.treebar.getUIValue(),self.treebar.getUIValue(),self.input.getUIValue(),self.comboinput.getUIValue()],self.host);self.dialog.close()}},_dialog_onhotkey:function(profile,key,control,shift,alt){if(key=="esc"){profile.boxing().close()}}}});Class("VisualJS.DelFile","linb.Com",{Instance:{customAttach:function(parent){var self=this,prop=self.properties,dlg=self.dialog;if(prop.fromRegion){dlg.setFromRegion(prop.fromRegion)}dlg.setCaption(prop.caption).setIcon(prop.icon).setIconPos(prop.iconPos);if(!dlg.get(0).root){dlg.create()}self.treebar.resetValue();dlg.show(parent,true);var arr=linb.UI.pickObj(prop.items),f=function(o){var self=arguments.callee;o.filter(function(o,i){delete o.group;if(o.sub&&o.sub.length){self(o.sub)}})};f(arr);self.treebar.clearItems().insertItems(arr)},_dialog_beforeclose:function(profile){this.dialog.hide();return false},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Dialog).host(t,"dialog").setLeft(247).setTop(120).setWidth(433).setHeight(210).setResizable(false).setMinBtn(false).setMaxBtn(false).setPinBtn(false).setCaption("dialog").onHotKeydown("_dialog_onhotkey").beforeClose("_dialog_beforeclose"));t.dialog.attach((new u.Button).host(t,"btnCancel").setLeft(80).setTop(150).setWidth(90).setCaption("$VisualJS.cancel").setIcon("img/App.gif").setIconPos("-16px -16px").onClick("_btncancel_onclick"));t.dialog.attach((new u.Button).host(t,"btnOK").setLeft(250).setTop(150).setWidth(90).setCaption("$VisualJS.ok").setIcon("img/App.gif").setIconPos("-64px -16px").onClick("_btnok_onclick"));t.dialog.attach((new u.PanelBar).host(t,"panelbar2").setDock("top").setHeight(140).setZIndex(1).setCaption("$VisualJS.delfile.sel").setCloseBtn(false).setLandBtn(false));t.panelbar2.attach((new u.TreeBar).host(t,"treebar").setDock("none").setPosition("relative").setItems([]).setIniFold(false).setSelMode("multi").beforeValueUpdated("_treebar_beforevalueupdated").onItemSelected("_treebar_onitemselected"));return n},_btncancel_onclick:function(profile,e,value){this.dialog.close()},_btnok_onclick:function(profile,e,value){var s=this.treebar.getUIValue(),self=this;if(!s){linb.message(linb.getRes("VisualJS.delfile.notarget"))}else{linb.UI.Dialog.confirm(linb.getRes("VisualJS.delfile.confirmdel"),linb.getRes("VisualJS.delfile.confirmdel2",s.split(";").length),function(){_.tryF(self.properties.onOK,[s],self.host);self.dialog.close()})}},_treebar_beforevalueupdated:function(profile,oldValue,newValue,showValue){var arr=newValue.split(";");arr.sort();arr.filter(function(o,j){for(var i=0,l=this.length;i<l;i++){if(i==j){break}if(this[j].startWith(this[i])){return false}}});return arr.join(";")},_dialog_onhotkey:function(profile,key,control,shift,alt){if(key=="esc"){profile.boxing().close()}}}});Class("VisualJS.About","linb.Com",{Instance:{customAttach:function(parent){var self=this,dlg=self.dialog,prop=self.properties;if(!dlg.get(0).root){dlg.create()}dlg.show(parent,true)},iniComponents:function(){var t=this,n=t._nodes=[],u=linb.UI,f=function(c){n.push(c.get(0))};f((new u.Dialog).host(t,"dialog").setLeft(250).setTop(150).setHeight(170).setCaption("$VisualJS.menu.about").setResizable(false).setMinBtn(false).setMaxBtn(false).setPinBtn(false).onHotKeydown("_dialog_onhotkey").beforeClose("_dialog2_beforeclose"));t.dialog.attach((new u.Div).host(t,"div12").setLeft(10).setTop(10).setWidth(260).setHeight(80).setHtml('Visual Js 1.0 <br /> Powered by jsLinb and phpLINB <br />&copy;2006-2007 All rights reserved by <a href="mailto:&#108;&#105;&#110;&#98;&#46;&#110;&#101;&#116;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">Yingbo Li</a>'));t.dialog.attach((new u.Button).host(t,"button3").setLeft(120).setTop(100).setCaption("O K").setWidth(50).setZIndex("10").onClick("_button3_onclick"));t.dialog.attach((new u.Div).host(t,"div9").setLeft(90).setTop(65).setWidth("120").setHeight("60").setZIndex("8").afterCreated("_div9_aftercreated").setCustomAppearance({KEY:"background:url(img/logo.gif);cursor:pointer;"}));return n},_div9_aftercreated:function(profile){profile.root.onClick(function(){linb.dom.submit("http://www.linb.net/VisualJS/")})},_dialog2_beforeclose:function(profile){profile.boxing().hide();return false},_dialog_onhotkey:function(profile,key,control,shift,alt){if(key=="esc"){profile.boxing().close()}},_button3_onclick:function(profile,e,value){this.dialog.close()}}});